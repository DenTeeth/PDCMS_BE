name: Deploy to DigitalOcean & Notify Discord

on:
  push:
    branches:
      - "feat/BE-903-deploy-digital-ocean" # Deploy khi push v√†o nh√°nh n√†y

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      # 2. Deploy to DigitalOcean Droplet via SSH
      - name: üöÄ Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          script: |
            # Navigate to project directory
            cd ~/PDCMS_BE || exit 1

            # Pull latest code
            echo "üì• Pulling latest code..."
            git pull origin feat/BE-903-deploy-digital-ocean

            # Stop containers
            echo "üõë Stopping containers..."
            docker-compose down

            # Remove old images to force rebuild
            echo "üóëÔ∏è  Removing old images..."
            docker rmi dentalclinic-app:latest || true

            # Build and start containers
            echo "üèóÔ∏è  Building and starting containers..."
            docker-compose up --build -d

            # Wait for app to be healthy
            echo "‚è≥ Waiting for application to be ready..."
            sleep 30

            # Health check
            echo "üè• Checking application health..."
            for i in {1..10}; do
              if curl -sf http://localhost:8080/actuator/health > /dev/null; then
                echo "‚úÖ Application is healthy!"
                exit 0
              fi
              echo "‚è≥ Waiting... attempt $i/10"
              sleep 10
            done

            echo "‚ùå Application health check failed!"
            docker-compose logs --tail=50 app
            exit 1

      # 3. Discord Notification - Success
      - name: üì¢ Discord Notification - Deploy Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          # Escape special characters in commit message
          COMMIT_MSG=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          # Format timestamp for Vietnam timezone (UTC+7)
          FORMATTED_TIME=$(TZ='Asia/Ho_Chi_Minh' date -d "$COMMIT_TIMESTAMP" '+%d/%m/%Y %H:%M:%S')

          # Download celebration GIF
          echo "üì• Downloading celebration GIF..."
          curl -L -o success.gif "https://media.discordapp.net/attachments/1134165112098398310/1450777439738396764/wjizi0a1cppf1.gif?ex=6943c547&is=694273c7&hm=d95c83a952e894f7d2f87a309ef1eccced89bc8d0b9a22b157ad47acd08b5380&=&width=300&height=300"

          # Create JSON payload with GIF as attachment
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "‚úÖ Deploy Success!",
              "color": 5763719,
              "description": "**Dental Clinic Backend** ƒë√£ ƒë∆∞·ª£c deploy th√†nh c√¥ng l√™n DigitalOcean!",
              "fields": [
                {
                  "name": "üåø Branch",
                  "value": "\`feat/BE-903-deploy-digital-ocean\`",
                  "inline": true
                },
                {
                  "name": "üìù Commit",
                  "value": "$COMMIT_MSG",
                  "inline": false
                },
                {
                  "name": "üë§ Author",
                  "value": "$AUTHOR_NAME",
                  "inline": true
                },
                {
                  "name": "‚è∞ Time",
                  "value": "$FORMATTED_TIME (GMT+7)",
                  "inline": true
                },
                {
                  "name": "üîó View Commit",
                  "value": "[Click here](https://github.com/$REPO/commit/$SHA)",
                  "inline": false
                }
              ],
              "image": {
                "url": "attachment://success.gif"
              },
              "footer": {
                "text": "Dental Clinic Management System"
              }
            }]
          }
          EOF
          )

          # Send to Discord with GIF attachment
          curl -X POST "$DISCORD_WEBHOOK" \
               -F "payload_json=$PAYLOAD" \
               -F "file=@success.gif"

      # 4. Discord Notification - Failure
      - name: üì¢ Discord Notification - Deploy Failed
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Escape special characters in commit message
          COMMIT_MSG=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          # Format timestamp for Vietnam timezone (UTC+7)
          FORMATTED_TIME=$(TZ='Asia/Ho_Chi_Minh' date -d "$COMMIT_TIMESTAMP" '+%d/%m/%Y %H:%M:%S')

          curl -X POST -H "Content-Type: application/json" \
               -d "{
                 \"embeds\": [{
                   \"title\": \"‚ùå Deploy Failed!\",
                   \"color\": 15158332,
                   \"description\": \"**C·∫¢NH B√ÅO:** Deploy **Dental Clinic Backend** th·∫•t b·∫°i!\",
                   \"fields\": [
                     {
                       \"name\": \"üåø Branch\",
                       \"value\": \"\`feat/BE-903-deploy-digital-ocean\`\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"üìù Commit\",
                       \"value\": \"$COMMIT_MSG\",
                       \"inline\": false
                     },
                     {
                       \"name\": \"üë§ Author\",
                       \"value\": \"$AUTHOR_NAME\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"‚è∞ Time\",
                       \"value\": \"$FORMATTED_TIME (GMT+7)\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"üîó View Logs\",
                       \"value\": \"[Click here](https://github.com/$REPO/actions/runs/$RUN_ID)\",
                       \"inline\": false
                     }
                   ],
                   \"thumbnail\": {
                     \"url\": \"https://cdn-icons-png.flaticon.com/512/1828/1828843.png\"
                   },
                   \"footer\": {
                     \"text\": \"Vui l√≤ng ki·ªÉm tra logs v√† fix l·ªói!\"
                   }
                 }]
               }" \
               "$DISCORD_WEBHOOK"
