name: Deploy to DigitalOcean & Notify Discord

on:
  push:
    branches:
      - "feat/BE-905-payment-implement" # Deploy when push to this branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      # 2. Deploy to DigitalOcean Droplet via SSH
      - name: üöÄ Deploy to DigitalOcean Droplet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          script: |
            # Navigate to project directory
            cd ~/PDCMS_BE || exit 1

            # Pull latest code
            echo "üì• Pulling latest code..."
            git pull origin feat/BE-904-push-notification

            # Stop containers and REMOVE VOLUMES (x√≥a DB ƒë·ªÉ t·∫°o m·ªõi)
            echo "üõë Stopping containers and removing volumes..."
            docker-compose down -v

            # Remove old images to force rebuild
            echo "üóëÔ∏è  Removing old images..."
            docker rmi pdcms_be-app || true
            docker rmi dentalclinic-app:latest || true

            # Clean up dangling volumes
            echo "üßπ Cleaning up dangling volumes..."
            docker volume prune -f

            # Build and start containers (DB s·∫Ω ƒë∆∞·ª£c t·∫°o m·ªõi v·ªõi seed data)
            echo "üèóÔ∏è  Building and starting containers..."
            docker-compose up --build -d

            # Show logs to verify seed data loading
            echo "üìã Checking seed data initialization..."
            docker-compose logs app | grep -i "seed data" || true

            # Wait for app to be healthy
            echo "‚è≥ Waiting for application to be ready..."
            sleep 30

            # Health check
            echo "üè• Checking application health..."
            for i in {1..10}; do
              if curl -sf http://localhost:8080/actuator/health > /dev/null; then
                echo "‚úÖ Application is healthy!"
                exit 0
              fi
              echo "‚è≥ Waiting... attempt $i/10"
              sleep 10
            done

            echo "‚ùå Application health check failed!"
            docker-compose logs --tail=50 app
            exit 1

      # 3. Discord Notification - Success
      - name: üì¢ Discord Notification - Deploy Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          # Escape special characters in commit message
          COMMIT_MSG=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          # Format timestamp for Vietnam timezone (UTC+7)
          FORMATTED_TIME=$(TZ='Asia/Ho_Chi_Minh' date -d "$COMMIT_TIMESTAMP" '+%d/%m/%Y %H:%M:%S')

          # Download celebration GIF
          echo "üì• Downloading celebration GIF..."
          curl -L -o success.gif "https://media.discordapp.net/attachments/1449969951010983976/1450802582200127599/success.gif?ex=69472872&is=6945d6f2&hm=39e33980bbca48a1f382fa106dd38e41ac4c1d53ae98edd36a19124c12d96243&=&width=300&height=300"

          # Create JSON payload with GIF as attachment
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "‚úÖ Deploy Success!",
              "color": 5763719,
              "description": "**Dental Clinic Backend** ƒë√£ ƒë∆∞·ª£c deploy th√†nh c√¥ng l√™n DigitalOcean!",
              "fields": [
                {
                  "name": "üåø Branch",
                  "value": "\`feat/BE-903-deploy-digital-ocean\`",
                  "inline": true
                },
                {
                  "name": "üìù Commit",
                  "value": "$COMMIT_MSG",
                  "inline": false
                },
                {
                  "name": "üë§ Author",
                  "value": "$AUTHOR_NAME",
                  "inline": true
                },
                {
                  "name": "‚è∞ Time",
                  "value": "$FORMATTED_TIME (GMT+7)",
                  "inline": true
                },
                {
                  "name": "üîó View Commit",
                  "value": "[Click here](https://github.com/$REPO/commit/$SHA)",
                  "inline": false
                }
              ],
              "image": {
                "url": "attachment://success.gif"
              },
              "footer": {
                "text": "Dental Clinic Management System"
              }
            }]
          }
          EOF
          )

          # Send to Discord with GIF attachment
          curl -X POST "$DISCORD_WEBHOOK" \
               -F "payload_json=$PAYLOAD" \
               -F "file=@success.gif"

      # 4. Discord Notification - Failure
      - name: üì¢ Discord Notification - Deploy Failed
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Escape special characters in commit message
          COMMIT_MSG=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          # Format timestamp for Vietnam timezone (UTC+7)
          FORMATTED_TIME=$(TZ='Asia/Ho_Chi_Minh' date -d "$COMMIT_TIMESTAMP" '+%d/%m/%Y %H:%M:%S')

          # Download error GIF
          echo "üì• Downloading error GIF..."
          curl -L -o error.gif "https://media.discordapp.net/attachments/1417100980700446784/1451043622559678475/VIDEO_DOWNLOAD_1765799525512_1765963467457.gif?ex=6944bd2e&is=69436bae&hm=398ce4a4d6ab1b7f85bcb2153401a2491aa8049da67c36ae101a5a693e7defdf&=&width=600&height=542"

          # Create JSON payload with GIF as attachment
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "‚ùå Deploy Failed!",
              "color": 15158332,
              "description": "‚ö†Ô∏è CANH BAO: Deploy **Dental Clinic Backend** that bai!",
              "fields": [
                {
                  "name": "Branch",
                  "value": "\`feat/BE-903-deploy-digital-ocean\`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "$COMMIT_MSG",
                  "inline": false
                },
                {
                  "name": "Author",
                  "value": "$AUTHOR_NAME",
                  "inline": true
                },
                {
                  "name": "Time",
                  "value": "$FORMATTED_TIME (GMT+7)",
                  "inline": true
                },
                {
                  "name": "View Logs",
                  "value": "[Click here](https://github.com/$REPO/actions/runs/$RUN_ID)",
                  "inline": false
                }
              ],
              "image": {
                "url": "attachment://error.gif"
              },
              "footer": {
                "text": "Vui long kiem tra logs va fix loi!"
              }
            }]
          }
          EOF
          )

          # Send to Discord with GIF attachment
          curl -F "payload_json=$PAYLOAD" -F "file=@error.gif" "$DISCORD_WEBHOOK"
