# BE-403 Appointment Management API

Base URL: /api/v1/appointments
Auth: Bearer Token
Permissions: CREATE_APPOINTMENT, VIEW_APPOINTMENT_ALL, VIEW_APPOINTMENT_OWN

## üìã API SUMMARY

| Endpoint           | Method | Permission                                     | Description                    |
| ------------------ | ------ | ---------------------------------------------- | ------------------------------ |
| `/available-times` | GET    | CREATE_APPOINTMENT                             | T√¨m slot tr·ªëng cho l·ªãch h·∫πn    |
| `/`                | POST   | CREATE_APPOINTMENT                             | T·∫°o l·ªãch h·∫πn m·ªõi               |
| `/`                | GET    | VIEW_APPOINTMENT_ALL ho·∫∑c VIEW_APPOINTMENT_OWN | Dashboard - Danh s√°ch l·ªãch h·∫πn |

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GET AVAILABLE TIMES
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Endpoint:
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM

Query Params:

- date (String Required) YYYY-MM-DD
- employeeCode (String Required) M√£ b√°c sƒ©
- serviceCodes (Array Required) Repeat: serviceCodes=A&serviceCodes=B
- participantCodes (Array Optional) M√£ ph·ª• t√°

Response 200:

```json
{
  "totalDurationNeeded": 40,
  "availableSlots": [
    {
      "startTime": "2025-11-15T08:00:00",
      "availableCompatibleRoomCodes": ["P-01", "P-02"]
    }
  ]
}
```

Errors:

```json
{"message":"EMPLOYEE_NOT_QUALIFIED"}
{"message":"Doctor has no shifts on 2025-12-25"}
{"message":"Employee not found"}
```

Test Cases:

Basic - 1 Service
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM

Basic - Multiple Services
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP002&serviceCodes=GEN_EXAM&serviceCodes=SCALING_L1

Advanced - Multiple Services with Participant
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM&serviceCodes=SCALING_L1&participantCodes=EMP007

Advanced - Complex: 3 Services + 2 Participants
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP002&serviceCodes=GEN_EXAM&serviceCodes=SCALING_L1&serviceCodes=CROWN_EMAX&participantCodes=EMP007&participantCodes=EMP008

Basic - With Participant
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM&participantCodes=EMP007

Edge Case - Part-time Dentist (Ca S√°ng)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP003&serviceCodes=EXTRACT_MILK

Edge Case - Part-time Dentist (Ca Chi·ªÅu)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP004&serviceCodes=EXTRACT_NORM

Critical - Full-time Dentist (Both Morning & Afternoon Shifts)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM
Expected: Returns slots from 08:00-11:15 (morning) AND 13:00-16:15 (afternoon)

Error Case - Not Qualified (EMP001 kh√¥ng c√≥ N·ªôi nha)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=FILLING_COMP

Error Case - No Shifts (Ch·ªß nh·∫≠t kh√¥ng l√†m vi·ªác)
GET /api/v1/appointments/available-times?date=2025-11-16&employeeCode=EMP001&serviceCodes=GEN_EXAM

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
POST CREATE APPOINTMENT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ö†Ô∏è IMPORTANT: URL must NOT have trailing slash!
‚úÖ Correct: POST http://localhost:8080/api/v1/appointments
‚ùå Wrong: POST http://localhost:8080/api/v1/appointments/

Endpoint:
POST /api/v1/appointments

Request Body:

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T10:00:00",
  "participantCodes": ["EMP007"],
  "notes": "Kh√°m t·ªïng qu√°t"
}
```

Request Fields:

- patientCode (String Required) - Generated by system when creating patient (format: BN-XXXX)
- employeeCode (String Required)
- roomCode (String Required) - Use room_code from rooms table (e.g., "P-01", "P-02", "P-04-IMPLANT")
- serviceCodes (Array Required)
- appointmentStartTime (String Required)
- participantCodes (Array Optional)
- notes (String Optional)

Response 201:

```json
{
  "appointmentCode": "APT-20251115-001",
  "status": "SCHEDULED",
  "appointmentStartTime": "2025-11-15T10:00:00",
  "appointmentEndTime": "2025-11-15T10:40:00",
  "expectedDurationMinutes": 40,
  "patient": { "patientCode": "BN-1001", "fullName": "ƒêo√†n Thanh Phong" },
  "doctor": { "employeeCode": "EMP001", "fullName": "L√™ Anh Khoa" },
  "room": { "roomCode": "P-01", "roomName": "Ph√≤ng th∆∞·ªùng 1" },
  "services": [
    { "serviceCode": "GEN_EXAM", "serviceName": "Kh√°m t·ªïng qu√°t & T∆∞ v·∫•n" }
  ],
  "participants": [
    {
      "employeeCode": "EMP007",
      "fullName": "ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n",
      "role": "ASSISTANT"
    }
  ]
}
```

Errors:

```json
{"message":"Patient code is required"}
{"message":"DOCTOR_NOT_AVAILABLE"}
{"message":"Patient not found"}
```

Test Cases:

Valid - Basic Appointment

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T10:00:00"
}
```

Advanced - Multiple Services (2 services)

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM", "SCALING_L1"],
  "appointmentStartTime": "2025-11-15T10:00:00",
  "notes": "Kh√°m v√† c·∫°o v√¥i"
}
```

Advanced - Multiple Services + Multiple Participants (Complex case)

```json
{
  "patientCode": "BN-1002",
  "employeeCode": "EMP002",
  "roomCode": "P-02",
  "serviceCodes": ["GEN_EXAM", "SCALING_L1", "CROWN_EMAX"],
  "appointmentStartTime": "2025-11-15T09:00:00",
  "participantCodes": ["EMP007", "EMP008", "EMP012"],
  "notes": "Ca ph·ª©c t·∫°p - 3 d·ªãch v·ª•, 3 ph·ª• t√°"
}
```

Note: EMP007 (Nguy√™n) and EMP008 (Khang) are full-time nurses available both morning & afternoon. EMP012 (Linh) is part-time intern.

Valid - Multiple Services + Participant

```json
{
  "patientCode": "BN-1002",
  "employeeCode": "EMP002",
  "roomCode": "P-02",
  "serviceCodes": ["GEN_EXAM", "SCALING_L1"],
  "appointmentStartTime": "2025-11-15T09:00:00",
  "participantCodes": ["EMP007"],
  "notes": "Kh√°m v√† c·∫°o v√¥i"
}
```

Note: EMP007 (ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n) is full-time nurse, has both morning & afternoon shifts.

Valid - Part-time Dentist (Chi·ªÅu)

```json
{
  "patientCode": "BN-1003",
  "employeeCode": "EMP004",
  "roomCode": "P-01",
  "serviceCodes": ["EXTRACT_NORM"],
  "appointmentStartTime": "2025-11-15T14:00:00"
}
```

Critical - Afternoon Appointment with Participant (Test full-time schedule)

```json
{
  "patientCode": "BN-1004",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T14:30:00",
  "participantCodes": ["EMP007"],
  "notes": "Ca chi·ªÅu - Full-time doctor"
}
```

‚ö†Ô∏è CONFLICT WARNING: This test case may fail with ROOM_SLOT_TAKEN if room P-01 is already booked during 14:30-15:15.
The error will now include conflicting appointment details: "Conflicting appointment: APT-XXXXXXXX-XXX (2025-11-15T14:00:00 to 2025-11-15T14:45:00)"
Expected on success: 201 Created with created_by = 0 (SYSTEM for admin)

Admin Create - Using SYSTEM employee

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T15:00:00",
  "notes": "T·∫°o b·ªüi Admin"
}
```

Token: Login as admin / 123456
Expected: created_by = 0 (SYSTEM employee)

Error Case - Double Booking
Create the same appointment twice
Expected: 400 DOCTOR_NOT_AVAILABLE

Error Case - Wrong Shift Time
Ca S√°ng (8-12h) but book at 14:00
Expected: 400 DOCTOR_NOT_AVAILABLE

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GET APPOINTMENT LIST (DASHBOARD)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Endpoint:
GET /api/v1/appointments

Authorization (PERMISSION-BASED, NOT ROLE-BASED):

- VIEW_APPOINTMENT_ALL: L·ªÖ t√¢n/Qu·∫£n l√Ω - Xem t·∫•t c·∫£, d√πng filters t·ª± do
- VIEW_APPOINTMENT_OWN: B√°c sƒ©/Y t√°/OBSERVER/B·ªánh nh√¢n - Filters b·ªã GHI ƒê√à

‚ö†Ô∏è CRITICAL: Logic ki·ªÉm tra PERMISSION_ID, KH√îNG ki·ªÉm tra role_id

Query Params (All Optional):

- page (Number) Default: 0
- size (Number) Default: 10
- sortBy (String) Default: "appointmentStartTime"
- sortDirection (String) Default: "ASC" (ASC|DESC)
- datePreset (String) ‚úÖ NEW - Quick date filter: TODAY | THIS_WEEK | NEXT_7_DAYS | THIS_MONTH
- dateFrom (String) YYYY-MM-DD - T·ª´ ng√†y (inclusive)
- dateTo (String) YYYY-MM-DD - ƒê·∫øn ng√†y (inclusive)
- today (Boolean) DEPRECATED - D√πng datePreset=TODAY thay th·∫ø
- status (Array) Repeat: status=SCHEDULED&status=CHECKED_IN
- patientCode (String) M√£ b·ªánh nh√¢n (VIEW_ALL only)
- patientName (String) ‚úÖ NEW - Search t√™n b·ªánh nh√¢n LIKE (VIEW_ALL only)
- patientPhone (String) ‚úÖ NEW - Search SƒêT b·ªánh nh√¢n LIKE (VIEW_ALL only)
- employeeCode (String) M√£ b√°c sƒ© ch√≠nh (VIEW_ALL only)
- roomCode (String) M√£ ph√≤ng
- serviceCode (String) ‚úÖ NEW - M√£ d·ªãch v·ª• (JOIN appointment_services)

RBAC Logic (Permission-based):

1. VIEW_APPOINTMENT_ALL (L·ªÖ t√¢n/Qu·∫£n l√Ω):
   ‚Üí Ki·ªÉm tra: auth.authorities contains "VIEW_APPOINTMENT_ALL"
   ‚Üí Xem T·∫§T C·∫¢ appointments
   ‚Üí Filters ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
   ‚Üí ‚úÖ C√≥ th·ªÉ search by patient name/phone

2. VIEW_APPOINTMENT_OWN + Employee (B√°c sƒ©/Y t√°/OBSERVER):
   ‚Üí Ki·ªÉm tra: auth.authorities contains "VIEW_APPOINTMENT_OWN"
   ‚Üí OVERRIDE: WHERE (appointments.employee_id = [my_employee_id]
   OR EXISTS (participant where employee_id = [my_employee_id]))
   ‚Üí PH·ªöT L·ªúI employeeCode t·ª´ client
   ‚Üí ‚ö†Ô∏è OBSERVER (Th·ª±c t·∫≠p sinh):
   ‚Ä¢ C√≥ quy·ªÅn VIEW_APPOINTMENT_OWN
   ‚Ä¢ Th·∫•y appointments M√Ä H·ªå THAM GIA (role = OBSERVER trong participants)
   ‚Ä¢ KH√îNG th·∫•y to√†n b·ªô appointments (security)
   ‚Ä¢ Frontend c·∫ßn th√™m permission ƒë·ªÉ xem medical history

3. VIEW_APPOINTMENT_OWN + Patient (B·ªánh nh√¢n):
   ‚Üí Ki·ªÉm tra: auth.authorities contains "VIEW_APPOINTMENT_OWN"
   ‚Üí OVERRIDE: WHERE appointments.patient_id = [my_patient_id]
   ‚Üí PH·ªöT L·ªúI patientCode t·ª´ client

Response 200:

```json
{
  "content": [
    {
      "appointmentCode": "APT-20251115-001",
      "status": "SCHEDULED",
      "computedStatus": "LATE",
      "minutesLate": 15,
      "appointmentStartTime": "2025-11-15T10:00:00",
      "appointmentEndTime": "2025-11-15T10:40:00",
      "expectedDurationMinutes": 40,
      "patient": {
        "patientCode": "BN-1001",
        "fullName": "ƒêo√†n Thanh Phong"
      },
      "doctor": {
        "employeeCode": "EMP001",
        "fullName": "L√™ Anh Khoa"
      },
      "room": {
        "roomCode": "P-01",
        "roomName": "Ph√≤ng th∆∞·ªùng 1"
      },
      "services": [
        {
          "serviceCode": "GEN_EXAM",
          "serviceName": "Kh√°m t·ªïng qu√°t & T∆∞ v·∫•n"
        }
      ],
      "participants": [
        {
          "employeeCode": "EMP007",
          "fullName": "ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n",
          "role": "ASSISTANT"
        }
      ],
      "notes": "Kh√°m t·ªïng qu√°t"
    }
  ],
  "page": 0,
  "size": 10,
  "totalPages": 5,
  "totalElements": 50
}
```

Computed Fields Explanation:

- computedStatus: T√≠nh d·ª±a tr√™n status + appointmentStartTime vs NOW()
  ‚Ä¢ CANCELLED: status == CANCELLED
  ‚Ä¢ COMPLETED: status == COMPLETED
  ‚Ä¢ NO_SHOW: status == NO_SHOW
  ‚Ä¢ CHECKED_IN: status == CHECKED_IN
  ‚Ä¢ IN_PROGRESS: status == IN_PROGRESS
  ‚Ä¢ LATE: status == SCHEDULED && NOW() > appointmentStartTime (B·ªánh nh√¢n ch∆∞a check-in)
  ‚Ä¢ UPCOMING: status == SCHEDULED && NOW() <= appointmentStartTime

- minutesLate: S·ªë ph√∫t tr·ªÖ (ch·ªâ c√≥ khi computedStatus = LATE)
  ‚Ä¢ T√≠nh: Duration.between(appointmentStartTime, NOW()).toMinutes()
  ‚Ä¢ Use case: Dashboard hi·ªÉn th·ªã "Tr·ªÖ 15 ph√∫t" v·ªõi m√†u ƒë·ªè

Test Cases:

Dashboard - L·ªÖ t√¢n - Xem t·∫•t c·∫£ l·ªãch h√¥m nay (DatePreset)
GET /api/v1/appointments?datePreset=TODAY
Token: L·ªÖ t√¢n (username: thuan.dk) v·ªõi permission VIEW_APPOINTMENT_ALL
Backend: Auto t√≠nh dateFrom=2025-11-04, dateTo=2025-11-04

Dashboard - L·ªÖ t√¢n - Xem l·ªãch tu·∫ßn n√†y (DatePreset)
GET /api/v1/appointments?datePreset=THIS_WEEK
Backend: Auto t√≠nh dateFrom=Monday, dateTo=Sunday c·ªßa tu·∫ßn hi·ªán t·∫°i

Dashboard - L·ªÖ t√¢n - Xem l·ªãch 7 ng√†y t·ªõi (DatePreset)
GET /api/v1/appointments?datePreset=NEXT_7_DAYS
Backend: Auto t√≠nh dateFrom=2025-11-04, dateTo=2025-11-10

Dashboard - L·ªÖ t√¢n - Xem l·ªãch th√°ng n√†y (DatePreset)
GET /api/v1/appointments?datePreset=THIS_MONTH
Backend: Auto t√≠nh dateFrom=2025-11-01, dateTo=2025-11-30

Critical - L·ªÖ t√¢n - T√åM THEO T√äN B·ªÜNH NH√ÇN
GET /api/v1/appointments?patientName=Phong
Backend: LOWER(CONCAT(first_name, ' ', last_name)) LIKE '%phong%'
Expected: Tr·∫£ v·ªÅ appointments c·ªßa "ƒêo√†n Thanh Phong" + "Ph·∫°m VƒÉn Phong"

Critical - L·ªÖ t√¢n - T√åM THEO S·ªê ƒêI·ªÜN THO·∫†I
GET /api/v1/appointments?patientPhone=0912
Backend: phone LIKE '%0912%'
Expected: Tr·∫£ v·ªÅ appointments c√≥ SƒêT ch·ª©a "0912"

Advanced - L·ªÖ t√¢n - T√åM THEO T√äN + SƒêT K·∫æT H·ª¢P
GET /api/v1/appointments?patientName=Thanh&patientPhone=0909&datePreset=THIS_MONTH
Use case: "T√¨m t·∫•t c·∫£ b·ªánh nh√¢n t√™n Thanh, SƒêT c√≥ 0909 trong th√°ng n√†y"

Dashboard - L·ªÖ t√¢n - L·ªçc theo ng√†y + status + b√°c sƒ©
GET /api/v1/appointments?dateFrom=2025-11-15&dateTo=2025-11-15&status=SCHEDULED&status=CHECKED_IN&employeeCode=EMP001

Critical - L·ªÖ t√¢n - L·ªåC THEO D·ªäCH V·ª§
GET /api/v1/appointments?serviceCode=IMPL_SURGERY_KR&dateFrom=2025-11-15&dateTo=2025-11-15
Backend: JOIN appointment_services WHERE service_code = 'IMPL_SURGERY_KR'
Use case: "Th√°ng n√†y c√≥ bao nhi√™u ca Implant?"

Advanced - L·ªÖ t√¢n - L·ªåC THEO NHI·ªÄU D·ªäCH V·ª§ (Multi-service filter)
GET /api/v1/appointments?serviceCode=GEN_EXAM&serviceCode=SCALING_L1&datePreset=THIS_WEEK
Use case: "Tu·∫ßn n√†y c√≥ bao nhi√™u ca kh√°m t·ªïng qu√°t ho·∫∑c c·∫°o v√¥i?"

Dashboard - L·ªÖ t√¢n - L·ªçc theo ph√≤ng
GET /api/v1/appointments?roomCode=P-01

Advanced - L·ªÖ t√¢n - L·ªçc ph·ª©c t·∫°p (Complex filter)
GET /api/v1/appointments?datePreset=THIS_MONTH&status=SCHEDULED&status=CHECKED_IN&employeeCode=EMP001&serviceCode=GEN_EXAM&sortBy=appointmentStartTime&sortDirection=ASC
Use case: "Th√°ng n√†y b√°c sƒ© Khoa c√≥ bao nhi√™u l·ªãch kh√°m t·ªïng qu√°t ƒë√£ ƒë·∫∑t ho·∫∑c ƒë√£ check-in?"

Dashboard - B√°c sƒ© - Xem l·ªãch c·ªßa m√¨nh (Auto-filter)
GET /api/v1/appointments?today=true
Token: B√°c sƒ© L√™ Anh Khoa (username: khoa.la) v·ªõi permission VIEW_APPOINTMENT_OWN
Backend: findByAccount_Username("khoa.la") returns employeeId = EMP001
Backend auto applies: WHERE (employee_id=EMP001 OR EXISTS participant)
Note: Backend PH·ªöT L·ªúI n·∫øu client c·ªë g·ª≠i employeeCode=EMP002

Dashboard - B√°c sƒ© - Xem l·ªãch tu·∫ßn t·ªõi
GET /api/v1/appointments?dateFrom=2025-11-11&dateTo=2025-11-17&sortBy=appointmentStartTime&sortDirection=ASC
Token: B√°c sƒ© (VIEW_APPOINTMENT_OWN)

Dashboard - Y t√°/Ph·ª• t√° - Xem l·ªãch tham gia
GET /api/v1/appointments?today=true
Token: Y t√° ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n (username: nguyen.dnk) v·ªõi VIEW_APPOINTMENT_OWN
Backend: Tr·∫£ v·ªÅ appointments WHERE participant.employee_id = EMP007

Critical - OBSERVER (Th·ª±c t·∫≠p sinh) - Xem l·ªãch ƒë∆∞·ª£c m·ªùi quan s√°t
GET /api/v1/appointments?today=true
Token: Th·ª±c t·∫≠p sinh Nguy·ªÖn Kh√°nh Linh (username: linh.nk) v·ªõi permission VIEW_APPOINTMENT_OWN
Backend: findByAccount_Username("linh.nk") returns employeeId = 12 (EMP012)
Backend: WHERE EXISTS (participant WHERE employee_id = 12 AND role = 'OBSERVER')
Security: CH·ªà TH·∫§Y appointments m√† h·ªç ƒë∆∞·ª£c th√™m v√†o danh s√°ch participants
Security: KH√îNG leak th√¥ng tin b·ªánh nh√¢n c·ªßa appointments kh√°c
Test Data: EMP012 - Nguy·ªÖn Kh√°nh Linh - Th·ª±c t·∫≠p sinh (ROLE_DENTIST_INTERN)
Expected: Tr·ªëng ban ƒë·∫ßu, sau khi add v√†o participant list m·ªõi th·∫•y

Advanced - OBSERVER - Th√™m v√†o participant, verify th·∫•y appointment
Step 1: Admin adds EMP012 to APT-20251115-001 as OBSERVER
Step 2: Login as linh.nk
Step 3: GET /api/v1/appointments?datePreset=TODAY
Step 4: Should return APT-20251115-001 in response

Advanced - OBSERVER - X√≥a kh·ªèi participant, verify kh√¥ng c√≤n th·∫•y
Step 1: Admin removes EMP012 from APT-20251115-001
Step 2: Login as linh.nk
Step 3: GET /api/v1/appointments?datePreset=TODAY
Step 4: Should return empty list

Dashboard - B·ªánh nh√¢n - Xem l·ªãch c·ªßa m√¨nh
GET /api/v1/appointments
Token: B·ªánh nh√¢n ƒêo√†n Thanh Phong (username: phong.dt) v·ªõi VIEW_APPOINTMENT_OWN
Backend: TODO - C·∫ßn mapping Patient.account
Backend t·ª± ƒë·ªông: WHERE patient_id = BN-1001

Dashboard - B·ªánh nh√¢n - Xem l·ªãch s·∫Øp t·ªõi
GET /api/v1/appointments?dateFrom=2025-11-15&status=SCHEDULED&sortBy=appointmentStartTime&sortDirection=ASC
Token: B·ªánh nh√¢n (VIEW_APPOINTMENT_OWN)

Security - B·ªánh nh√¢n c·ªë xem l·ªãch ng∆∞·ªùi kh√°c - PH·ªöT L·ªúI filter
GET /api/v1/appointments?patientCode=BN-1002
Token: B·ªánh nh√¢n BN-1001 v·ªõi VIEW_APPOINTMENT_OWN
Backend: OVERRIDE - V·∫´n ch·ªâ tr·∫£ v·ªÅ appointments c·ªßa BN-1001
Security: Prevent privilege escalation

Security - B√°c sƒ© c·ªë xem l·ªãch b√°c sƒ© kh√°c - PH·ªöT L·ªúI filter
GET /api/v1/appointments?employeeCode=EMP002
Token: B√°c sƒ© EMP001 v·ªõi VIEW_APPOINTMENT_OWN
Backend: OVERRIDE - V·∫´n ch·ªâ tr·∫£ v·ªÅ appointments c·ªßa EMP001
Security: Prevent data leak

Security - OBSERVER c·ªë xem t·∫•t c·∫£ l·ªãch - B·ªä GI·ªöI H·∫†N
GET /api/v1/appointments?dateFrom=2025-11-01&dateTo=2025-11-30
Token: OBSERVER v·ªõi VIEW_APPOINTMENT_OWN
Backend: CH·ªà tr·∫£ v·ªÅ appointments m√† OBSERVER THAM GIA
Security: Kh√¥ng c√≥ permission VIEW_APPOINTMENT_ALL n√™n kh√¥ng th·∫•y to√†n b·ªô

Error Case - Unauthorized - Kh√¥ng c√≥ quy·ªÅn VIEW
GET /api/v1/appointments
Token: Kh√¥ng c√≥ VIEW_APPOINTMENT_ALL ho·∫∑c VIEW_APPOINTMENT_OWN
Expected: 403 Forbidden

Implementation Notes:

CRITICAL IMPROVEMENTS (vs Initial Design):

1. Search by Patient Name/Phone (FIXED)

   - JOIN patients table
   - LIKE search: LOWER(CONCAT(first_name, ' ', last_name)) LIKE '%search%'
   - Real-world use case: L·ªÖ t√¢n g√µ "Lan" thay v√¨ nh·ªõ "BN-1234"

2. Filter by Service Code (ADDED)

   - JOIN appointment_services + services
   - Use case: "Th√°ng n√†y c√≥ bao nhi√™u ca Implant?"

3. Permission-based Auth (FIXED)

   - Check "VIEW_APPOINTMENT_ALL" in authorities
   - NOT check role_id
   - Data-driven: Easy to add new roles via database

4. OBSERVER Role Security (CLARIFIED)

   - OBSERVER c√≥ permission VIEW_APPOINTMENT_OWN
   - CH·ªà th·∫•y appointments h·ªç ƒë∆∞·ª£c m·ªùi tham gia
   - Principle of Least Privilege
   - Medical data privacy protection
   - Test user: EMP012 - Nguy·ªÖn Kh√°nh Linh (linh.nk)

5. DatePreset Enum (IMPLEMENTED)

   - TODAY, THIS_WEEK, NEXT_7_DAYS, THIS_MONTH
   - Backend t·ª± ƒë·ªông t√≠nh dateFrom/dateTo
   - KH√îNG c·∫ßn thay ƒë·ªïi DB Schema V16
   - Use case: Dashboard quick filters

6. Computed Fields (IMPLEMENTED)

   - computedStatus: UPCOMING | LATE | IN_PROGRESS | CHECKED_IN | COMPLETED | CANCELLED
   - minutesLate: S·ªë ph√∫t tr·ªÖ (Duration.between)
   - Real-time calculation based on NOW()
   - Use case: Dashboard color coding (red for LATE)

7. N+1 Query Warning (Noted - TODO)

   - Current: Load patient/employee per appointment (N+1)
   - TODO: Batch loading or @EntityGraph
   - Impact: Performance with 100+ appointments

8. Patient RBAC Mapping (TODO)
   - Employee mapping: DONE (findByAccount_Username)
   - Patient mapping: TODO (need Patient.account relationship)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SEED DATA
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Test Accounts:

- admin (Admin) - ROLE_ADMIN - All permissions (username: admin, password: 123456)
- thuan.dk (L·ªÖ t√¢n) - ROLE_RECEPTIONIST - Permission: VIEW_APPOINTMENT_ALL
- khoa.la (B√°c sƒ©) - ROLE_DENTIST - Permission: VIEW_APPOINTMENT_OWN
- nguyen.dnk (Y t√°) - ROLE_NURSE - Permission: VIEW_APPOINTMENT_OWN
- linh.nk (Th·ª±c t·∫≠p sinh) ‚úÖ NEW - ROLE_DENTIST_INTERN - Permission: VIEW_APPOINTMENT_OWN
- phong.dt (B·ªánh nh√¢n) - ROLE_PATIENT - Permission: VIEW_APPOINTMENT_OWN (TODO: mapping)

Employees (Ca S√°ng 8-12h on 2025-11-15):

- EMP001 - L√™ Anh Khoa - Nha sƒ© (Full-time) - Ch·ªânh nha (ID 1), Ph·ª•c h·ªìi (ID 4), STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP002 - Tr·ªãnh C√¥ng Th√°i - Nha sƒ© (Full-time) - N·ªôi nha (ID 2), RƒÉng th·∫©m m·ªπ (ID 7), STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP003 - Jimmy Donaldson - Nha sƒ© (Part-time flex) - Nha khoa tr·∫ª em (ID 6), STANDARD (ID 8) - Morning only
- EMP007 - ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n - Y t√° (Full-time) - STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP008 - Nguy·ªÖn Tr·∫ßn Tu·∫•n Khang - Y t√° (Full-time) - STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP009 - Hu·ª≥nh T·∫•n Quang Nh·∫≠t - Y t√° (Part-time fixed) - STANDARD (ID 8) - Morning only

Employees (Ca Chi·ªÅu 13-17h on 2025-11-15):

- EMP001 - L√™ Anh Khoa - Nha sƒ© (Full-time) - ‚úÖ BOTH SHIFTS
- EMP002 - Tr·ªãnh C√¥ng Th√°i - Nha sƒ© (Full-time) - ‚úÖ BOTH SHIFTS
- EMP004 - Junya Ota - Nha sƒ© (Part-time fixed) - Ph·∫´u thu·∫≠t (ID 5), STANDARD (ID 8) - Afternoon only
- EMP007 - ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n - Y t√° (Full-time) - ‚úÖ BOTH SHIFTS
- EMP008 - Nguy·ªÖn Tr·∫ßn Tu·∫•n Khang - Y t√° (Full-time) - ‚úÖ BOTH SHIFTS
- EMP010 - Ng√¥ ƒê√¨nh Ch√≠nh - Y t√° (Part-time flex) - STANDARD (ID 8) - Afternoon only

‚ö†Ô∏è IMPORTANT: When selecting participants for test cases:

- Morning appointments (08:00-12:00): Can use EMP007, EMP008, EMP009
- Afternoon appointments (13:00-17:00): Can use EMP007, EMP008, EMP010
- EMP007 and EMP008 are FULL-TIME, available both morning & afternoon
- Part-time employees only work specific shifts

Services:

- GEN_EXAM (30 min + 15 buffer) STANDARD (ID 8)
- SCALING_L1 (45 min + 15 buffer) Nha chu (ID 3)
- ORTHO_BRACES_ON (90 min + 30 buffer) Ch·ªânh nha (ID 1)
- CROWN_EMAX (60 min + 15 buffer) Ph·ª•c h·ªìi (ID 4)
- IMPL_SURGERY_KR (90 min + 30 buffer) Ph·ª•c h·ªìi (ID 4)

Rooms:

- P-01 (STANDARD) - Compatible v·ªõi t·∫•t c·∫£ STANDARD services
- P-02 (STANDARD) - Compatible v·ªõi t·∫•t c·∫£ STANDARD services
- P-03 (STANDARD) - Compatible v·ªõi t·∫•t c·∫£ STANDARD services
- P-04-IMPLANT (IMPLANT) - Compatible v·ªõi IMPLANT + t·∫•t c·∫£ STANDARD services
