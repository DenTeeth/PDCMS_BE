# BE-403 Appointment Management API

Base URL: /api/v1/appointments
Auth: Bearer Token
Permissions: CREATE_APPOINTMENT, VIEW_APPOINTMENT_ALL, VIEW_APPOINTMENT_OWN

## üìã API SUMMARY

| Endpoint                    | Method | Permission                                     | Description                     |
| --------------------------- | ------ | ---------------------------------------------- | ------------------------------- |
| `/available-times`          | GET    | CREATE_APPOINTMENT                             | T√¨m slot tr·ªëng cho l·ªãch h·∫πn     |
| `/`                         | POST   | CREATE_APPOINTMENT                             | T·∫°o l·ªãch h·∫πn m·ªõi                |
| `/`                         | GET    | VIEW_APPOINTMENT_ALL ho·∫∑c VIEW_APPOINTMENT_OWN | Dashboard - Danh s√°ch l·ªãch h·∫πn  |
| `/{appointmentCode}`        | GET    | VIEW_APPOINTMENT_ALL ho·∫∑c VIEW_APPOINTMENT_OWN | Chi ti·∫øt l·ªãch h·∫πn               |
| `/{appointmentCode}/status` | PATCH  | UPDATE_APPOINTMENT_STATUS                      | C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªãch h·∫πn ‚≠ê |

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GET AVAILABLE TIMES
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Endpoint:
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM

Query Params:

- date (String Required) YYYY-MM-DD
- employeeCode (String Required) M√£ b√°c sƒ©
- serviceCodes (Array Required) Repeat: serviceCodes=A&serviceCodes=B
- participantCodes (Array Optional) M√£ ph·ª• t√°

Response 200:

```json
{
  "totalDurationNeeded": 40,
  "availableSlots": [
    {
      "startTime": "2025-11-15T08:00:00",
      "availableCompatibleRoomCodes": ["P-01", "P-02"]
    }
  ]
}
```

Errors:

```json
{"message":"EMPLOYEE_NOT_QUALIFIED"}
{"message":"Doctor has no shifts on 2025-12-25"}
{"message":"Employee not found"}
```

Test Cases:

Basic - 1 Service
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM

Basic - Multiple Services
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP002&serviceCodes=GEN_EXAM&serviceCodes=SCALING_L1

Advanced - Multiple Services with Participant
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM&serviceCodes=SCALING_L1&participantCodes=EMP007

Advanced - Complex: 3 Services + 2 Participants
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP002&serviceCodes=GEN_EXAM&serviceCodes=SCALING_L1&serviceCodes=CROWN_EMAX&participantCodes=EMP007&participantCodes=EMP008

Basic - With Participant
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM&participantCodes=EMP007

Edge Case - Part-time Dentist (Ca S√°ng)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP003&serviceCodes=EXTRACT_MILK

Edge Case - Part-time Dentist (Ca Chi·ªÅu)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP004&serviceCodes=EXTRACT_NORM

Critical - Full-time Dentist (Both Morning & Afternoon Shifts)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=GEN_EXAM
Expected: Returns slots from 08:00-11:15 (morning) AND 13:00-16:15 (afternoon)

Error Case - Not Qualified (EMP001 kh√¥ng c√≥ N·ªôi nha)
GET /api/v1/appointments/available-times?date=2025-11-15&employeeCode=EMP001&serviceCodes=FILLING_COMP

Error Case - No Shifts (Ch·ªß nh·∫≠t kh√¥ng l√†m vi·ªác)
GET /api/v1/appointments/available-times?date=2025-11-16&employeeCode=EMP001&serviceCodes=GEN_EXAM

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
POST CREATE APPOINTMENT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ö†Ô∏è IMPORTANT: URL must NOT have trailing slash!
‚úÖ Correct: POST http://localhost:8080/api/v1/appointments
‚ùå Wrong: POST http://localhost:8080/api/v1/appointments/

Endpoint:
POST /api/v1/appointments

Request Body:

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T10:00:00",
  "participantCodes": ["EMP007"],
  "notes": "Kh√°m t·ªïng qu√°t"
}
```

Request Fields:

- patientCode (String Required) - Generated by system when creating patient (format: BN-XXXX)
- employeeCode (String Required)
- roomCode (String Required) - Use room_code from rooms table (e.g., "P-01", "P-02", "P-04-IMPLANT")
- serviceCodes (Array Required)
- appointmentStartTime (String Required)
- participantCodes (Array Optional)
- notes (String Optional)

Response 201:

```json
{
  "appointmentCode": "APT-20251115-001",
  "status": "SCHEDULED",
  "appointmentStartTime": "2025-11-15T10:00:00",
  "appointmentEndTime": "2025-11-15T10:40:00",
  "expectedDurationMinutes": 40,
  "patient": { "patientCode": "BN-1001", "fullName": "ƒêo√†n Thanh Phong" },
  "doctor": { "employeeCode": "EMP001", "fullName": "L√™ Anh Khoa" },
  "room": { "roomCode": "P-01", "roomName": "Ph√≤ng th∆∞·ªùng 1" },
  "services": [
    { "serviceCode": "GEN_EXAM", "serviceName": "Kh√°m t·ªïng qu√°t & T∆∞ v·∫•n" }
  ],
  "participants": [
    {
      "employeeCode": "EMP007",
      "fullName": "ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n",
      "role": "ASSISTANT"
    }
  ]
}
```

Errors:

```json
{"message":"Patient code is required"}
{"message":"DOCTOR_NOT_AVAILABLE"}
{"message":"Patient not found"}
```

Test Cases:

Valid - Basic Appointment

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T10:00:00"
}
```

Advanced - Multiple Services (2 services)

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM", "SCALING_L1"],
  "appointmentStartTime": "2025-11-15T10:00:00",
  "notes": "Kh√°m v√† c·∫°o v√¥i"
}
```

Advanced - Multiple Services + Multiple Participants (Complex case)

```json
{
  "patientCode": "BN-1002",
  "employeeCode": "EMP002",
  "roomCode": "P-02",
  "serviceCodes": ["GEN_EXAM", "SCALING_L1", "CROWN_EMAX"],
  "appointmentStartTime": "2025-11-15T09:00:00",
  "participantCodes": ["EMP007", "EMP008", "EMP012"],
  "notes": "Ca ph·ª©c t·∫°p - 3 d·ªãch v·ª•, 3 ph·ª• t√°"
}
```

Note: EMP007 (Nguy√™n) and EMP008 (Khang) are full-time nurses available both morning & afternoon. EMP012 (Linh) is part-time intern.

Valid - Multiple Services + Participant

```json
{
  "patientCode": "BN-1002",
  "employeeCode": "EMP002",
  "roomCode": "P-02",
  "serviceCodes": ["GEN_EXAM", "SCALING_L1"],
  "appointmentStartTime": "2025-11-15T09:00:00",
  "participantCodes": ["EMP007"],
  "notes": "Kh√°m v√† c·∫°o v√¥i"
}
```

Note: EMP007 (ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n) is full-time nurse, has both morning & afternoon shifts.

Valid - Part-time Dentist (Chi·ªÅu)

```json
{
  "patientCode": "BN-1003",
  "employeeCode": "EMP004",
  "roomCode": "P-01",
  "serviceCodes": ["EXTRACT_NORM"],
  "appointmentStartTime": "2025-11-15T14:00:00"
}
```

Critical - Afternoon Appointment with Participant (Test full-time schedule)

```json
{
  "patientCode": "BN-1004",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T14:30:00",
  "participantCodes": ["EMP007"],
  "notes": "Ca chi·ªÅu - Full-time doctor"
}
```

‚ö†Ô∏è CONFLICT WARNING: This test case may fail with ROOM_SLOT_TAKEN if room P-01 is already booked during 14:30-15:15.
The error will now include conflicting appointment details: "Conflicting appointment: APT-XXXXXXXX-XXX (2025-11-15T14:00:00 to 2025-11-15T14:45:00)"
Expected on success: 201 Created with created_by = 0 (SYSTEM for admin)

Admin Create - Using SYSTEM employee

```json
{
  "patientCode": "BN-1001",
  "employeeCode": "EMP001",
  "roomCode": "P-01",
  "serviceCodes": ["GEN_EXAM"],
  "appointmentStartTime": "2025-11-15T15:00:00",
  "notes": "T·∫°o b·ªüi Admin"
}
```

Token: Login as admin / 123456
Expected: created_by = 0 (SYSTEM employee)

Error Case - Double Booking
Create the same appointment twice
Expected: 400 DOCTOR_NOT_AVAILABLE

Error Case - Wrong Shift Time
Ca S√°ng (8-12h) but book at 14:00
Expected: 400 DOCTOR_NOT_AVAILABLE

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GET APPOINTMENT LIST (DASHBOARD)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Endpoint:
GET /api/v1/appointments

Authorization (PERMISSION-BASED, NOT ROLE-BASED):

- VIEW_APPOINTMENT_ALL: L·ªÖ t√¢n/Qu·∫£n l√Ω - Xem t·∫•t c·∫£, d√πng filters t·ª± do
- VIEW_APPOINTMENT_OWN: B√°c sƒ©/Y t√°/OBSERVER/B·ªánh nh√¢n - Filters b·ªã GHI ƒê√à

‚ö†Ô∏è CRITICAL: Logic ki·ªÉm tra PERMISSION_ID, KH√îNG ki·ªÉm tra role_id

Query Params (All Optional):

- page (Number) Default: 0
- size (Number) Default: 10
- sortBy (String) Default: "appointmentStartTime"
- sortDirection (String) Default: "ASC" (ASC|DESC)
- datePreset (String) ‚úÖ NEW - Quick date filter: TODAY | THIS_WEEK | NEXT_7_DAYS | THIS_MONTH
- dateFrom (String) YYYY-MM-DD - T·ª´ ng√†y (inclusive)
- dateTo (String) YYYY-MM-DD - ƒê·∫øn ng√†y (inclusive)
- today (Boolean) DEPRECATED - D√πng datePreset=TODAY thay th·∫ø
- status (Array) Repeat: status=SCHEDULED&status=CHECKED_IN
- patientCode (String) M√£ b·ªánh nh√¢n (VIEW_ALL only)
- patientName (String) ‚úÖ NEW - Search t√™n b·ªánh nh√¢n LIKE (VIEW_ALL only)
- patientPhone (String) ‚úÖ NEW - Search SƒêT b·ªánh nh√¢n LIKE (VIEW_ALL only)
- employeeCode (String) M√£ b√°c sƒ© ch√≠nh (VIEW_ALL only)
- roomCode (String) M√£ ph√≤ng
- serviceCode (String) ‚úÖ NEW - M√£ d·ªãch v·ª• (JOIN appointment_services)

RBAC Logic (Permission-based):

1. VIEW_APPOINTMENT_ALL (L·ªÖ t√¢n/Qu·∫£n l√Ω):
   ‚Üí Ki·ªÉm tra: auth.authorities contains "VIEW_APPOINTMENT_ALL"
   ‚Üí Xem T·∫§T C·∫¢ appointments
   ‚Üí Filters ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
   ‚Üí ‚úÖ C√≥ th·ªÉ search by patient name/phone

2. VIEW_APPOINTMENT_OWN + Employee (B√°c sƒ©/Y t√°/OBSERVER):
   ‚Üí Ki·ªÉm tra: auth.authorities contains "VIEW_APPOINTMENT_OWN"
   ‚Üí OVERRIDE: WHERE (appointments.employee_id = [my_employee_id]
   OR EXISTS (participant where employee_id = [my_employee_id]))
   ‚Üí PH·ªöT L·ªúI employeeCode t·ª´ client
   ‚Üí ‚ö†Ô∏è OBSERVER (Th·ª±c t·∫≠p sinh):
   ‚Ä¢ C√≥ quy·ªÅn VIEW_APPOINTMENT_OWN
   ‚Ä¢ Th·∫•y appointments M√Ä H·ªå THAM GIA (role = OBSERVER trong participants)
   ‚Ä¢ KH√îNG th·∫•y to√†n b·ªô appointments (security)
   ‚Ä¢ Frontend c·∫ßn th√™m permission ƒë·ªÉ xem medical history

3. VIEW_APPOINTMENT_OWN + Patient (B·ªánh nh√¢n):
   ‚Üí Ki·ªÉm tra: auth.authorities contains "VIEW_APPOINTMENT_OWN"
   ‚Üí OVERRIDE: WHERE appointments.patient_id = [my_patient_id]
   ‚Üí PH·ªöT L·ªúI patientCode t·ª´ client

Response 200:

```json
{
  "content": [
    {
      "appointmentCode": "APT-20251115-001",
      "status": "SCHEDULED",
      "computedStatus": "LATE",
      "minutesLate": 15,
      "appointmentStartTime": "2025-11-15T10:00:00",
      "appointmentEndTime": "2025-11-15T10:40:00",
      "expectedDurationMinutes": 40,
      "patient": {
        "patientCode": "BN-1001",
        "fullName": "ƒêo√†n Thanh Phong"
      },
      "doctor": {
        "employeeCode": "EMP001",
        "fullName": "L√™ Anh Khoa"
      },
      "room": {
        "roomCode": "P-01",
        "roomName": "Ph√≤ng th∆∞·ªùng 1"
      },
      "services": [
        {
          "serviceCode": "GEN_EXAM",
          "serviceName": "Kh√°m t·ªïng qu√°t & T∆∞ v·∫•n"
        }
      ],
      "participants": [
        {
          "employeeCode": "EMP007",
          "fullName": "ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n",
          "role": "ASSISTANT"
        }
      ],
      "notes": "Kh√°m t·ªïng qu√°t"
    }
  ],
  "page": 0,
  "size": 10,
  "totalPages": 5,
  "totalElements": 50
}
```

Computed Fields Explanation:

- computedStatus: T√≠nh d·ª±a tr√™n status + appointmentStartTime vs NOW()
  ‚Ä¢ CANCELLED: status == CANCELLED
  ‚Ä¢ COMPLETED: status == COMPLETED
  ‚Ä¢ NO_SHOW: status == NO_SHOW
  ‚Ä¢ CHECKED_IN: status == CHECKED_IN
  ‚Ä¢ IN_PROGRESS: status == IN_PROGRESS
  ‚Ä¢ LATE: status == SCHEDULED && NOW() > appointmentStartTime (B·ªánh nh√¢n ch∆∞a check-in)
  ‚Ä¢ UPCOMING: status == SCHEDULED && NOW() <= appointmentStartTime

- minutesLate: S·ªë ph√∫t tr·ªÖ (ch·ªâ c√≥ khi computedStatus = LATE)
  ‚Ä¢ T√≠nh: Duration.between(appointmentStartTime, NOW()).toMinutes()
  ‚Ä¢ Use case: Dashboard hi·ªÉn th·ªã "Tr·ªÖ 15 ph√∫t" v·ªõi m√†u ƒë·ªè

Test Cases:

Dashboard - L·ªÖ t√¢n - Xem t·∫•t c·∫£ l·ªãch h√¥m nay (DatePreset)
GET /api/v1/appointments?datePreset=TODAY
Token: L·ªÖ t√¢n (username: thuan.dk) v·ªõi permission VIEW_APPOINTMENT_ALL
Backend: Auto t√≠nh dateFrom=2025-11-04, dateTo=2025-11-04

Dashboard - L·ªÖ t√¢n - Xem l·ªãch tu·∫ßn n√†y (DatePreset)
GET /api/v1/appointments?datePreset=THIS_WEEK
Backend: Auto t√≠nh dateFrom=Monday, dateTo=Sunday c·ªßa tu·∫ßn hi·ªán t·∫°i

Dashboard - L·ªÖ t√¢n - Xem l·ªãch 7 ng√†y t·ªõi (DatePreset)
GET /api/v1/appointments?datePreset=NEXT_7_DAYS
Backend: Auto t√≠nh dateFrom=2025-11-04, dateTo=2025-11-10

Dashboard - L·ªÖ t√¢n - Xem l·ªãch th√°ng n√†y (DatePreset)
GET /api/v1/appointments?datePreset=THIS_MONTH
Backend: Auto t√≠nh dateFrom=2025-11-01, dateTo=2025-11-30

Critical - L·ªÖ t√¢n - T√åM THEO T√äN B·ªÜNH NH√ÇN
GET /api/v1/appointments?patientName=Phong
Backend: LOWER(CONCAT(first_name, ' ', last_name)) LIKE '%phong%'
Expected: Tr·∫£ v·ªÅ appointments c·ªßa "ƒêo√†n Thanh Phong" + "Ph·∫°m VƒÉn Phong"

Critical - L·ªÖ t√¢n - T√åM THEO S·ªê ƒêI·ªÜN THO·∫†I
GET /api/v1/appointments?patientPhone=0912
Backend: phone LIKE '%0912%'
Expected: Tr·∫£ v·ªÅ appointments c√≥ SƒêT ch·ª©a "0912"

Advanced - L·ªÖ t√¢n - T√åM THEO T√äN + SƒêT K·∫æT H·ª¢P
GET /api/v1/appointments?patientName=Thanh&patientPhone=0909&datePreset=THIS_MONTH
Use case: "T√¨m t·∫•t c·∫£ b·ªánh nh√¢n t√™n Thanh, SƒêT c√≥ 0909 trong th√°ng n√†y"

Dashboard - L·ªÖ t√¢n - L·ªçc theo ng√†y + status + b√°c sƒ©
GET /api/v1/appointments?dateFrom=2025-11-15&dateTo=2025-11-15&status=SCHEDULED&status=CHECKED_IN&employeeCode=EMP001

Critical - L·ªÖ t√¢n - L·ªåC THEO D·ªäCH V·ª§
GET /api/v1/appointments?serviceCode=IMPL_SURGERY_KR&dateFrom=2025-11-15&dateTo=2025-11-15
Backend: JOIN appointment_services WHERE service_code = 'IMPL_SURGERY_KR'
Use case: "Th√°ng n√†y c√≥ bao nhi√™u ca Implant?"

Advanced - L·ªÖ t√¢n - L·ªåC THEO NHI·ªÄU D·ªäCH V·ª§ (Multi-service filter)
GET /api/v1/appointments?serviceCode=GEN_EXAM&serviceCode=SCALING_L1&datePreset=THIS_WEEK
Use case: "Tu·∫ßn n√†y c√≥ bao nhi√™u ca kh√°m t·ªïng qu√°t ho·∫∑c c·∫°o v√¥i?"

Dashboard - L·ªÖ t√¢n - L·ªçc theo ph√≤ng
GET /api/v1/appointments?roomCode=P-01

Advanced - L·ªÖ t√¢n - L·ªçc ph·ª©c t·∫°p (Complex filter)
GET /api/v1/appointments?datePreset=THIS_MONTH&status=SCHEDULED&status=CHECKED_IN&employeeCode=EMP001&serviceCode=GEN_EXAM&sortBy=appointmentStartTime&sortDirection=ASC
Use case: "Th√°ng n√†y b√°c sƒ© Khoa c√≥ bao nhi√™u l·ªãch kh√°m t·ªïng qu√°t ƒë√£ ƒë·∫∑t ho·∫∑c ƒë√£ check-in?"

Dashboard - B√°c sƒ© - Xem l·ªãch c·ªßa m√¨nh (Auto-filter)
GET /api/v1/appointments?today=true
Token: B√°c sƒ© L√™ Anh Khoa (username: khoa.la) v·ªõi permission VIEW_APPOINTMENT_OWN
Backend: findByAccount_Username("khoa.la") returns employeeId = EMP001
Backend auto applies: WHERE (employee_id=EMP001 OR EXISTS participant)
Note: Backend PH·ªöT L·ªúI n·∫øu client c·ªë g·ª≠i employeeCode=EMP002

Dashboard - B√°c sƒ© - Xem l·ªãch tu·∫ßn t·ªõi
GET /api/v1/appointments?dateFrom=2025-11-11&dateTo=2025-11-17&sortBy=appointmentStartTime&sortDirection=ASC
Token: B√°c sƒ© (VIEW_APPOINTMENT_OWN)

Dashboard - Y t√°/Ph·ª• t√° - Xem l·ªãch tham gia
GET /api/v1/appointments?today=true
Token: Y t√° ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n (username: nguyen.dnk) v·ªõi VIEW_APPOINTMENT_OWN
Backend: Tr·∫£ v·ªÅ appointments WHERE participant.employee_id = EMP007

Critical - OBSERVER (Th·ª±c t·∫≠p sinh) - Xem l·ªãch ƒë∆∞·ª£c m·ªùi quan s√°t
GET /api/v1/appointments?today=true
Token: Th·ª±c t·∫≠p sinh Nguy·ªÖn Kh√°nh Linh (username: linh.nk) v·ªõi permission VIEW_APPOINTMENT_OWN
Backend: findByAccount_Username("linh.nk") returns employeeId = 12 (EMP012)
Backend: WHERE EXISTS (participant WHERE employee_id = 12 AND role = 'OBSERVER')
Security: CH·ªà TH·∫§Y appointments m√† h·ªç ƒë∆∞·ª£c th√™m v√†o danh s√°ch participants
Security: KH√îNG leak th√¥ng tin b·ªánh nh√¢n c·ªßa appointments kh√°c
Test Data: EMP012 - Nguy·ªÖn Kh√°nh Linh - Th·ª±c t·∫≠p sinh (ROLE_DENTIST_INTERN)
Expected: Tr·ªëng ban ƒë·∫ßu, sau khi add v√†o participant list m·ªõi th·∫•y

Advanced - OBSERVER - Th√™m v√†o participant, verify th·∫•y appointment
Step 1: Admin adds EMP012 to APT-20251115-001 as OBSERVER
Step 2: Login as linh.nk
Step 3: GET /api/v1/appointments?datePreset=TODAY
Step 4: Should return APT-20251115-001 in response

Advanced - OBSERVER - X√≥a kh·ªèi participant, verify kh√¥ng c√≤n th·∫•y
Step 1: Admin removes EMP012 from APT-20251115-001
Step 2: Login as linh.nk
Step 3: GET /api/v1/appointments?datePreset=TODAY
Step 4: Should return empty list

Dashboard - B·ªánh nh√¢n - Xem l·ªãch c·ªßa m√¨nh
GET /api/v1/appointments
Token: B·ªánh nh√¢n ƒêo√†n Thanh Phong (username: phong.dt) v·ªõi VIEW_APPOINTMENT_OWN
Backend: TODO - C·∫ßn mapping Patient.account
Backend t·ª± ƒë·ªông: WHERE patient_id = BN-1001

Dashboard - B·ªánh nh√¢n - Xem l·ªãch s·∫Øp t·ªõi
GET /api/v1/appointments?dateFrom=2025-11-15&status=SCHEDULED&sortBy=appointmentStartTime&sortDirection=ASC
Token: B·ªánh nh√¢n (VIEW_APPOINTMENT_OWN)

Security - B·ªánh nh√¢n c·ªë xem l·ªãch ng∆∞·ªùi kh√°c - PH·ªöT L·ªúI filter
GET /api/v1/appointments?patientCode=BN-1002
Token: B·ªánh nh√¢n BN-1001 v·ªõi VIEW_APPOINTMENT_OWN
Backend: OVERRIDE - V·∫´n ch·ªâ tr·∫£ v·ªÅ appointments c·ªßa BN-1001
Security: Prevent privilege escalation

Security - B√°c sƒ© c·ªë xem l·ªãch b√°c sƒ© kh√°c - PH·ªöT L·ªúI filter
GET /api/v1/appointments?employeeCode=EMP002
Token: B√°c sƒ© EMP001 v·ªõi VIEW_APPOINTMENT_OWN
Backend: OVERRIDE - V·∫´n ch·ªâ tr·∫£ v·ªÅ appointments c·ªßa EMP001
Security: Prevent data leak

Security - OBSERVER c·ªë xem t·∫•t c·∫£ l·ªãch - B·ªä GI·ªöI H·∫†N
GET /api/v1/appointments?dateFrom=2025-11-01&dateTo=2025-11-30
Token: OBSERVER v·ªõi VIEW_APPOINTMENT_OWN
Backend: CH·ªà tr·∫£ v·ªÅ appointments m√† OBSERVER THAM GIA
Security: Kh√¥ng c√≥ permission VIEW_APPOINTMENT_ALL n√™n kh√¥ng th·∫•y to√†n b·ªô

Error Case - Unauthorized - Kh√¥ng c√≥ quy·ªÅn VIEW
GET /api/v1/appointments
Token: Kh√¥ng c√≥ VIEW_APPOINTMENT_ALL ho·∫∑c VIEW_APPOINTMENT_OWN
Expected: 403 Forbidden

Implementation Notes:

CRITICAL IMPROVEMENTS (vs Initial Design):

1. Search by Patient Name/Phone (FIXED)

   - JOIN patients table
   - LIKE search: LOWER(CONCAT(first_name, ' ', last_name)) LIKE '%search%'
   - Real-world use case: L·ªÖ t√¢n g√µ "Lan" thay v√¨ nh·ªõ "BN-1234"

2. Filter by Service Code (ADDED)

   - JOIN appointment_services + services
   - Use case: "Th√°ng n√†y c√≥ bao nhi√™u ca Implant?"

3. Permission-based Auth (FIXED)

   - Check "VIEW_APPOINTMENT_ALL" in authorities
   - NOT check role_id
   - Data-driven: Easy to add new roles via database

4. OBSERVER Role Security (CLARIFIED)

   - OBSERVER c√≥ permission VIEW_APPOINTMENT_OWN
   - CH·ªà th·∫•y appointments h·ªç ƒë∆∞·ª£c m·ªùi tham gia
   - Principle of Least Privilege
   - Medical data privacy protection
   - Test user: EMP012 - Nguy·ªÖn Kh√°nh Linh (linh.nk)

5. DatePreset Enum (IMPLEMENTED)

   - TODAY, THIS_WEEK, NEXT_7_DAYS, THIS_MONTH
   - Backend t·ª± ƒë·ªông t√≠nh dateFrom/dateTo
   - KH√îNG c·∫ßn thay ƒë·ªïi DB Schema V16
   - Use case: Dashboard quick filters

6. Computed Fields (IMPLEMENTED)

   - computedStatus: UPCOMING | LATE | IN_PROGRESS | CHECKED_IN | COMPLETED | CANCELLED
   - minutesLate: S·ªë ph√∫t tr·ªÖ (Duration.between)
   - Real-time calculation based on NOW()
   - Use case: Dashboard color coding (red for LATE)

7. N+1 Query Warning (Noted - TODO)

   - Current: Load patient/employee per appointment (N+1)
   - TODO: Batch loading or @EntityGraph
   - Impact: Performance with 100+ appointments

8. Patient RBAC Mapping (TODO)
   - Employee mapping: DONE (findByAccount_Username)
   - Patient mapping: TODO (need Patient.account relationship)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
SEED DATA
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Test Accounts:

- admin (Admin) - ROLE_ADMIN - All permissions (username: admin, password: 123456)
- thuan.dk (L·ªÖ t√¢n) - ROLE_RECEPTIONIST - Permission: VIEW_APPOINTMENT_ALL
- khoa.la (B√°c sƒ©) - ROLE_DENTIST - Permission: VIEW_APPOINTMENT_OWN
- nguyen.dnk (Y t√°) - ROLE_NURSE - Permission: VIEW_APPOINTMENT_OWN
- linh.nk (Th·ª±c t·∫≠p sinh) ‚úÖ NEW - ROLE_DENTIST_INTERN - Permission: VIEW_APPOINTMENT_OWN
- phong.dt (B·ªánh nh√¢n) - ROLE_PATIENT - Permission: VIEW_APPOINTMENT_OWN (TODO: mapping)

Employees (Ca S√°ng 8-12h on 2025-11-15):

- EMP001 - L√™ Anh Khoa - Nha sƒ© (Full-time) - Ch·ªânh nha (ID 1), Ph·ª•c h·ªìi (ID 4), STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP002 - Tr·ªãnh C√¥ng Th√°i - Nha sƒ© (Full-time) - N·ªôi nha (ID 2), RƒÉng th·∫©m m·ªπ (ID 7), STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP003 - Jimmy Donaldson - Nha sƒ© (Part-time flex) - Nha khoa tr·∫ª em (ID 6), STANDARD (ID 8) - Morning only
- EMP007 - ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n - Y t√° (Full-time) - STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP008 - Nguy·ªÖn Tr·∫ßn Tu·∫•n Khang - Y t√° (Full-time) - STANDARD (ID 8) - ‚úÖ BOTH SHIFTS
- EMP009 - Hu·ª≥nh T·∫•n Quang Nh·∫≠t - Y t√° (Part-time fixed) - STANDARD (ID 8) - Morning only

Employees (Ca Chi·ªÅu 13-17h on 2025-11-15):

- EMP001 - L√™ Anh Khoa - Nha sƒ© (Full-time) - ‚úÖ BOTH SHIFTS
- EMP002 - Tr·ªãnh C√¥ng Th√°i - Nha sƒ© (Full-time) - ‚úÖ BOTH SHIFTS
- EMP004 - Junya Ota - Nha sƒ© (Part-time fixed) - Ph·∫´u thu·∫≠t (ID 5), STANDARD (ID 8) - Afternoon only
- EMP007 - ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n - Y t√° (Full-time) - ‚úÖ BOTH SHIFTS
- EMP008 - Nguy·ªÖn Tr·∫ßn Tu·∫•n Khang - Y t√° (Full-time) - ‚úÖ BOTH SHIFTS
- EMP010 - Ng√¥ ƒê√¨nh Ch√≠nh - Y t√° (Part-time flex) - STANDARD (ID 8) - Afternoon only

‚ö†Ô∏è IMPORTANT: When selecting participants for test cases:

- Morning appointments (08:00-12:00): Can use EMP007, EMP008, EMP009
- Afternoon appointments (13:00-17:00): Can use EMP007, EMP008, EMP010
- EMP007 and EMP008 are FULL-TIME, available both morning & afternoon
- Part-time employees only work specific shifts

Services:

- GEN_EXAM (30 min + 15 buffer) STANDARD (ID 8)
- SCALING_L1 (45 min + 15 buffer) Nha chu (ID 3)
- ORTHO_BRACES_ON (90 min + 30 buffer) Ch·ªânh nha (ID 1)
- CROWN_EMAX (60 min + 15 buffer) Ph·ª•c h·ªìi (ID 4)
- IMPL_SURGERY_KR (90 min + 30 buffer) Ph·ª•c h·ªìi (ID 4)

Rooms:

- P-01 (STANDARD) - Compatible v·ªõi t·∫•t c·∫£ STANDARD services
- P-02 (STANDARD) - Compatible v·ªõi t·∫•t c·∫£ STANDARD services
- P-03 (STANDARD) - Compatible v·ªõi t·∫•t c·∫£ STANDARD services
- P-04-IMPLANT (IMPLANT) - Compatible v·ªõi IMPLANT + t·∫•t c·∫£ STANDARD services

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GET APPOINTMENT DETAIL (P3.4)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Endpoint:
GET /api/v1/appointments/{appointmentCode}

Permission:

- VIEW_APPOINTMENT_ALL: C√≥ th·ªÉ xem b·∫•t k·ª≥ appointment n√†o
- VIEW_APPOINTMENT_OWN:
  - Patient ch·ªâ xem ƒë∆∞·ª£c appointment c·ªßa m√¨nh
  - Employee ch·ªâ xem ƒë∆∞·ª£c appointment m√† h·ªç l√† doctor HO·∫∂C participant

Response 200:

```json
{
  "appointmentId": 1,
  "appointmentCode": "APT-20251104-001",
  "status": "SCHEDULED",
  "computedStatus": "LATE",
  "minutesLate": 74,
  "appointmentStartTime": "2025-11-04T09:00:00",
  "appointmentEndTime": "2025-11-04T09:45:00",
  "expectedDurationMinutes": 45,
  "actualStartTime": null,
  "actualEndTime": null,
  "cancellationReason": null,
  "notes": "B·ªánh nh√¢n c√≥ ti·ªÅn s·ª≠ cao huy·∫øt √°p",
  "patient": {
    "patientCode": "BN-1001",
    "fullName": "ƒêo√†n Thanh Phong",
    "phone": "0909123456",
    "dateOfBirth": "1990-01-01"
  },
  "doctor": {
    "employeeCode": "EMP001",
    "fullName": "L√™ Anh Khoa"
  },
  "room": {
    "roomCode": "P-01",
    "roomName": "Room P-01"
  },
  "services": [
    {
      "serviceCode": "GEN_EXAM",
      "serviceName": "Kh√°m t·ªïng qu√°t & T∆∞ v·∫•n"
    }
  ],
  "participants": [
    {
      "employeeCode": "EMP007",
      "fullName": "ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n",
      "role": "ASSISTANT"
    }
  ],
  "createdBy": "ƒê·ªó Kh√°nh Thu·∫≠n",
  "createdAt": "2025-11-03T14:00:00"
}
```

Response 404 (Appointment Not Found):

```json
{
  "type": "https://dental-clinic.com/problems/not-found",
  "title": "Resource Not Found",
  "status": 404,
  "detail": "Appointment not found with code: APT-99999-999",
  "errorCode": "APPOINTMENT_NOT_FOUND"
}
```

Response 403 (Access Denied):

```json
{
  "type": "about:blank",
  "title": "Forbidden",
  "status": 403,
  "detail": "You can only view your own appointments"
}
```

Test Cases:

### Success Case 1: Admin/Receptionist xem b·∫•t k·ª≥ appointment n√†o (VIEW_APPOINTMENT_ALL)

**Login as**: admin (ho·∫∑c thuan.dk - Receptionist)

```
GET /api/v1/appointments/APT-20251104-001
Authorization: Bearer {{admin_token}}
```

**Expected**: 200 OK v·ªõi full details

### Success Case 2: Patient xem appointment c·ªßa ch√≠nh m√¨nh (VIEW_APPOINTMENT_OWN)

**Login as**: phong.dt (B·ªánh nh√¢n BN-1001)

```
GET /api/v1/appointments/APT-20251104-001
Authorization: Bearer {{phong_token}}
```

**Pre-condition**: Appointment APT-20251104-001 ph·∫£i thu·ªôc v·ªÅ patient BN-1001

**Expected**: 200 OK v·ªõi full details

### Success Case 3: Doctor xem appointment m√† m√¨nh l√† b√°c sƒ© ch√≠nh (VIEW_APPOINTMENT_OWN)

**Login as**: khoa.la (Doctor EMP001 - L√™ Anh Khoa)

```
GET /api/v1/appointments/APT-20251104-001
Authorization: Bearer {{khoa_token}}
```

**Pre-condition**: Appointment APT-20251104-001 ph·∫£i c√≥ employeeId = EMP001

**Expected**: 200 OK v·ªõi full details

### Success Case 4: Employee xem appointment m√† m√¨nh l√† participant (VIEW_APPOINTMENT_OWN)

**Login as**: nguyen.dnk (Nurse EMP007 - ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n)

```
GET /api/v1/appointments/APT-20251104-001
Authorization: Bearer {{nguyen_token}}
```

**Pre-condition**: Appointment APT-20251104-001 ph·∫£i c√≥ EMP007 trong participants

**Expected**: 200 OK v·ªõi full details

### Error Case 1: Patient c·ªë g·∫Øng xem appointment c·ªßa ng∆∞·ªùi kh√°c (403 FORBIDDEN)

**Login as**: phong.dt (Patient BN-1001)

```
GET /api/v1/appointments/APT-20251104-002
Authorization: Bearer {{phong_token}}
```

**Pre-condition**: Appointment APT-20251104-002 thu·ªôc v·ªÅ patient BN-1002 (kh√¥ng ph·∫£i BN-1001)

**Expected**: 403 FORBIDDEN

```json
{
  "type": "about:blank",
  "title": "Forbidden",
  "status": 403,
  "detail": "You can only view your own appointments"
}
```

### Error Case 2: Employee kh√¥ng li√™n quan c·ªë g·∫Øng xem appointment (403 FORBIDDEN)

**Login as**: khoa.la (Doctor EMP001)

```
GET /api/v1/appointments/APT-20251104-003
Authorization: Bearer {{khoa_token}}
```

**Pre-condition**:

- Appointment APT-20251104-003 c√≥ employeeId = EMP002 (kh√¥ng ph·∫£i EMP001)
- EMP001 KH√îNG c√≥ trong participants c·ªßa appointment n√†y

**Expected**: 403 FORBIDDEN

```json
{
  "type": "about:blank",
  "title": "Forbidden",
  "status": 403,
  "detail": "You can only view appointments where you are involved"
}
```

### Error Case 3: Appointment kh√¥ng t·ªìn t·∫°i (404 NOT FOUND)

**Login as**: admin

```
GET /api/v1/appointments/APT-99999-999
Authorization: Bearer {{admin_token}}
```

**Expected**: 404 NOT FOUND

```json
{
  "type": "https://dental-clinic.com/problems/not-found",
  "title": "Resource Not Found",
  "status": 404,
  "detail": "Appointment not found with code: APT-99999-999",
  "errorCode": "APPOINTMENT_NOT_FOUND"
}
```

### Edge Case 1: Appointment ƒë√£ CANCELLED - Hi·ªÉn th·ªã cancellationReason

**Login as**: admin

```
GET /api/v1/appointments/APT-CANCELLED-001
Authorization: Bearer {{admin_token}}
```

**Pre-condition**:

- Appointment c√≥ status = CANCELLED
- C√≥ audit log v·ªõi actionType = CANCEL v√† notes = "B·ªánh nh√¢n h·ªßy do b·∫≠n ƒë·ªôt xu·∫•t"

**Expected**: 200 OK

```json
{
  "appointmentCode": "APT-CANCELLED-001",
  "status": "CANCELLED",
  "computedStatus": "CANCELLED",
  "cancellationReason": "PATIENT_REQUEST: B·ªánh nh√¢n h·ªßy do b·∫≠n ƒë·ªôt xu·∫•t",
  ...
}
```

### Edge Case 2: Appointment ƒë√£ COMPLETED - Hi·ªÉn th·ªã actualStartTime/actualEndTime

**Login as**: admin

```
GET /api/v1/appointments/APT-COMPLETED-001
Authorization: Bearer {{admin_token}}
```

**Pre-condition**: Appointment c√≥ status = COMPLETED

**Expected**: 200 OK

```json
{
  "appointmentCode": "APT-COMPLETED-001",
  "status": "COMPLETED",
  "computedStatus": "COMPLETED",
  "appointmentStartTime": "2025-11-03T09:00:00",
  "appointmentEndTime": "2025-11-03T09:45:00",
  "actualStartTime": "2025-11-03T09:05:00",
  "actualEndTime": "2025-11-03T09:50:00",
  ...
}
```

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
IMPLEMENTATION NOTES (P3.4)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. RBAC Logic

   - Ki·ªÉm tra permission VIEW_APPOINTMENT_ALL tr∆∞·ªõc
   - N·∫øu kh√¥ng c√≥, check VIEW_APPOINTMENT_OWN:
     - base_role = patient: So s√°nh patientId
     - base_role = employee: Ki·ªÉm tra employeeId HO·∫∂C participant

2. Cancellation Reason

   - Ch·ªâ load khi status = CANCELLED
   - Query appointment_audit_logs v·ªõi actionType = CANCEL
   - Gh√©p reasonCode + notes th√†nh chu·ªói
   - N·∫øu kh√¥ng c√≥ audit log ‚Üí cancellationReason = null

3. Response Fields

   - appointmentId: Internal PK (cho FE d·ªÖ reference)
   - actualStartTime/actualEndTime: T·ª´ DB (nullable)
   - patient.phone, patient.dateOfBirth: B·ªï sung cho detail view
   - createdBy: T√™n c·ªßa employee (JOIN v·ªõi employees table)

4. Performance

   - N+1 query acceptable cho detail view (1 appointment at a time)
   - Future: Batch load participants n·∫øu c·∫ßn

5. Security

   - Token PH·∫¢I ch·ª©a: account_id, base_role, patient_id (if patient), employee_id (if employee)
   - AccessDeniedException ‚Üí Spring Security t·ª± ƒë·ªông tr·∫£ v·ªÅ 403
     The AT command has been deprecated. Please use schtasks.exe instead.

The request is not supported.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
PATCH UPDATE APPOINTMENT STATUS (P3.5)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚≠ê CRITICAL API - Most important for daily clinic operations

Endpoint:
PATCH /api/v1/appointments/{appointmentCode}/status

Permission:

- UPDATE_APPOINTMENT_STATUS

Description:
C·∫≠p nh·∫≠t tr·∫°ng th√°i v·∫≠n h√†nh c·ªßa l·ªãch h·∫πn (Check-in, B·∫Øt ƒë·∫ßu kh√°m, Ho√†n th√†nh, H·ªßy, V·∫Øng m·∫∑t).
API n√†y s·ª≠ d·ª•ng SELECT FOR UPDATE ƒë·ªÉ tr√°nh race condition khi nhi·ªÅu l·ªÖ t√¢n/b√°c sƒ© c·∫≠p nh·∫≠t c√πng l√∫c.

‚öôÔ∏è State Machine (CRITICAL - Must Follow):

```
SCHEDULED (ƒê√£ ƒë·∫∑t l·ªãch)
   ‚îú‚îÄ> CHECKED_IN (B·ªánh nh√¢n ƒë·∫øn, ng·ªìi ph√≤ng ch·ªù)
   ‚îú‚îÄ> CANCELLED (H·ªßy l·ªãch)
   ‚îî‚îÄ> NO_SHOW (Kh√¥ng ƒë·∫øn)

CHECKED_IN (ƒê√£ check-in)
   ‚îú‚îÄ> IN_PROGRESS (B√°c sƒ© b·∫Øt ƒë·∫ßu kh√°m)
   ‚îî‚îÄ> CANCELLED (H·ªßy sau khi ƒë√£ check-in)

IN_PROGRESS (ƒêang kh√°m)
   ‚îú‚îÄ> COMPLETED (Ho√†n th√†nh)
   ‚îî‚îÄ> CANCELLED (H·ªßy gi·ªØa ch·ª´ng - hi·∫øm g·∫∑p)

COMPLETED (Terminal state - kh√¥ng chuy·ªÉn ƒë∆∞·ª£c)
CANCELLED (Terminal state - kh√¥ng chuy·ªÉn ƒë∆∞·ª£c)
NO_SHOW (Terminal state - kh√¥ng chuy·ªÉn ƒë∆∞·ª£c)
```

‚è∞ Timestamp Logic (CRITICAL):

```
SCHEDULED -> CHECKED_IN:
   ‚ùå KH√îNG c·∫≠p nh·∫≠t actualStartTime
   ‚úÖ B·ªánh nh√¢n ch·ªâ m·ªõi ƒë·∫øn, ch∆∞a v√†o gh·∫ø

CHECKED_IN -> IN_PROGRESS:
   ‚úÖ C·∫¨P NH·∫¨T actualStartTime = NOW()
   ‚úÖ B√°c sƒ© b·∫Øt ƒë·∫ßu kh√°m th·ª±c s·ª±

IN_PROGRESS -> COMPLETED:
   ‚úÖ C·∫¨P NH·∫¨T actualEndTime = NOW()
   ‚úÖ K·∫øt th√∫c ƒëi·ªÅu tr·ªã
```

Request Body (Case 1: Check-in):

```json
{
  "status": "CHECKED_IN",
  "notes": "B·ªánh nh√¢n ƒë·∫øn ƒë√∫ng gi·ªù"
}
```

Request Body (Case 2: B·∫Øt ƒë·∫ßu kh√°m):

```json
{
  "status": "IN_PROGRESS",
  "notes": "B·∫Øt ƒë·∫ßu kh√°m"
}
```

Request Body (Case 3: Ho√†n th√†nh):

```json
{
  "status": "COMPLETED",
  "notes": "Ho√†n th√†nh ƒëi·ªÅu tr·ªã"
}
```

Request Body (Case 4: H·ªßy l·ªãch - REQUIRED reasonCode):

```json
{
  "status": "CANCELLED",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "B·ªánh nh√¢n b√°o b·∫≠n ƒë·ªôt xu·∫•t"
}
```

Request Body (Case 5: B·ªánh nh√¢n kh√¥ng ƒë·∫øn):

```json
{
  "status": "NO_SHOW",
  "notes": "ƒê√£ g·ªçi 3 l·∫ßn kh√¥ng nghe m√°y"
}
```

Request Fields:

- status (String Required) - CHECKED_IN | IN_PROGRESS | COMPLETED | CANCELLED | NO_SHOW
- reasonCode (String) - B·∫Øt bu·ªôc khi status=CANCELLED (VD: PATIENT_REQUEST, DOCTOR_UNAVAILABLE)
- notes (String Optional) - Ghi ch√∫ th√™m

Response 200 (Same structure as API 3.4):

```json
{
  "appointmentId": 1,
  "appointmentCode": "APT-20251104-001",
  "status": "IN_PROGRESS",
  "computedStatus": "IN_PROGRESS",
  "minutesLate": 0,
  "appointmentStartTime": "2025-11-04T09:00:00",
  "appointmentEndTime": "2025-11-04T09:45:00",
  "expectedDurationMinutes": 45,
  "actualStartTime": "2025-11-04T09:05:00",
  "actualEndTime": null,
  "cancellationReason": null,
  "notes": "B·∫Øt ƒë·∫ßu kh√°m",
  "patient": {
    "patientCode": "BN-1001",
    "fullName": "ƒêo√†n Thanh Phong",
    "phone": "0909123456",
    "dateOfBirth": "1990-01-01"
  },
  "doctor": {
    "employeeCode": "EMP001",
    "fullName": "L√™ Anh Khoa"
  },
  "room": {
    "roomCode": "P-01",
    "roomName": "Room P-01"
  },
  "services": [
    {
      "serviceCode": "GEN_EXAM",
      "serviceName": "Kh√°m t·ªïng qu√°t & T∆∞ v·∫•n"
    }
  ],
  "participants": [
    {
      "employeeCode": "EMP007",
      "fullName": "ƒêo√†n Nguy·ªÖn Kh√¥i Nguy√™n",
      "role": "ASSISTANT"
    }
  ],
  "createdBy": "ƒê·ªó Kh√°nh Thu·∫≠n",
  "createdAt": "2025-11-03T14:00:00"
}
```

Response 404 (Appointment Not Found):

```json
{
  "type": "https://dental-clinic.com/problems/not-found",
  "title": "Resource Not Found",
  "status": 404,
  "detail": "Appointment not found with code: APT-99999-999",
  "errorCode": "APPOINTMENT_NOT_FOUND"
}
```

Response 409 (Invalid State Transition):

```json
{
  "type": "about:blank",
  "title": "Business Rule Violation",
  "status": 409,
  "detail": "Cannot transition from COMPLETED to CHECKED_IN. Allowed transitions: []",
  "errorCode": "INVALID_STATE_TRANSITION"
}
```

Response 400 (Missing Reason Code):

```json
{
  "type": "about:blank",
  "title": "Bad Request",
  "status": 400,
  "detail": "Reason code is required when cancelling an appointment",
  "errorCode": "REASON_CODE_REQUIRED"
}
```

Test Cases:

### Success Case 1: L·ªÖ t√¢n check-in b·ªánh nh√¢n (SCHEDULED -> CHECKED_IN)

**Login as**: thuan.dk (Receptionist)

```
PATCH /api/v1/appointments/APT-20251104-001/status
Authorization: Bearer {{receptionist_token}}

{
  "status": "CHECKED_IN",
  "notes": "B·ªánh nh√¢n ƒë·∫øn ƒë√∫ng gi·ªù"
}
```

**Expected**: 200 OK

- status = "CHECKED_IN"
- actualStartTime = null (Ch∆∞a v√†o gh·∫ø)
- actualEndTime = null

**Use case**: B·ªánh nh√¢n ƒë·∫øn ph√≤ng kh√°m, l·ªÖ t√¢n b·∫•m check-in, b·ªánh nh√¢n ng·ªìi ph√≤ng ch·ªù.

### Success Case 2: B√°c sƒ© b·∫Øt ƒë·∫ßu kh√°m (CHECKED_IN -> IN_PROGRESS)

**Login as**: khoa.la (Doctor EMP001)

```
PATCH /api/v1/appointments/APT-20251104-001/status
Authorization: Bearer {{doctor_token}}

{
  "status": "IN_PROGRESS",
  "notes": "B·∫Øt ƒë·∫ßu kh√°m"
}
```

**Expected**: 200 OK

- status = "IN_PROGRESS"
- actualStartTime = "2025-11-04T09:05:00" (NOW - Th·ªùi ƒëi·ªÉm g·ªçi API)
- actualEndTime = null

**Use case**: B·ªánh nh√¢n v√†o gh·∫ø, b√°c sƒ© b·∫•m "B·∫Øt ƒë·∫ßu", h·ªá th·ªëng ghi th·ªùi gian kh√°m th·ª±c t·∫ø.

### Success Case 3: B√°c sƒ© ho√†n th√†nh kh√°m (IN_PROGRESS -> COMPLETED)

**Login as**: khoa.la (Doctor EMP001)

```
PATCH /api/v1/appointments/APT-20251104-001/status
Authorization: Bearer {{doctor_token}}

{
  "status": "COMPLETED",
  "notes": "Ho√†n th√†nh ƒëi·ªÅu tr·ªã"
}
```

**Expected**: 200 OK

- status = "COMPLETED"
- actualStartTime = "2025-11-04T09:05:00" (T·ª´ step tr∆∞·ªõc)
- actualEndTime = "2025-11-04T09:50:00" (NOW - Th·ªùi ƒëi·ªÉm g·ªçi API)

**Business Metrics**:

- Patient Wait Time = actualStartTime - (CHECKED_IN time)
- Treatment Duration = actualEndTime - actualStartTime

### Success Case 4: L·ªÖ t√¢n h·ªßy l·ªãch v·ªõi l√Ω do (SCHEDULED -> CANCELLED)

**Login as**: thuan.dk (Receptionist)

```
PATCH /api/v1/appointments/APT-20251104-002/status
Authorization: Bearer {{receptionist_token}}

{
  "status": "CANCELLED",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "B·ªánh nh√¢n g·ªçi ƒëi·ªán b√°o b·∫≠n ƒë·ªôt xu·∫•t"
}
```

**Expected**: 200 OK

- status = "CANCELLED"
- cancellationReason = "PATIENT_REQUEST: B·ªánh nh√¢n g·ªçi ƒëi·ªán b√°o b·∫≠n ƒë·ªôt xu·∫•t"

**Audit Log**: INSERT v·ªõi actionType = STATUS_CHANGE, reasonCode = PATIENT_REQUEST

### Success Case 5: L·ªÖ t√¢n ƒë√°nh d·∫•u b·ªánh nh√¢n kh√¥ng ƒë·∫øn (SCHEDULED -> NO_SHOW)

**Login as**: thuan.dk (Receptionist)

```
PATCH /api/v1/appointments/APT-20251104-003/status
Authorization: Bearer {{receptionist_token}}

{
  "status": "NO_SHOW",
  "notes": "ƒê√£ g·ªçi 3 l·∫ßn kh√¥ng nghe m√°y"
}
```

**Expected**: 200 OK

- status = "NO_SHOW"

**Use case**: Qu√° gi·ªù h·∫πn 15 ph√∫t, l·ªÖ t√¢n ƒë√°nh d·∫•u kh√¥ng ƒë·∫øn.

### Error Case 1: Chuy·ªÉn t·ª´ tr·∫°ng th√°i cu·ªëi (COMPLETED -> CHECKED_IN)

**Login as**: admin

```
PATCH /api/v1/appointments/APT-COMPLETED-001/status
Authorization: Bearer {{admin_token}}

{
  "status": "CHECKED_IN"
}
```

**Expected**: 409 CONFLICT

```json
{
  "errorCode": "INVALID_STATE_TRANSITION",
  "detail": "Cannot transition from COMPLETED to CHECKED_IN. Allowed transitions: []"
}
```

**Reason**: COMPLETED l√† tr·∫°ng th√°i cu·ªëi, kh√¥ng th·ªÉ chuy·ªÉn.

### Error Case 2: H·ªßy l·ªãch m√† kh√¥ng c√≥ reasonCode

**Login as**: thuan.dk (Receptionist)

```
PATCH /api/v1/appointments/APT-20251104-004/status
Authorization: Bearer {{receptionist_token}}

{
  "status": "CANCELLED"
}
```

**Expected**: 400 BAD REQUEST

```json
{
  "errorCode": "REASON_CODE_REQUIRED",
  "detail": "Reason code is required when cancelling an appointment"
}
```

### Error Case 3: B·ªè qua b∆∞·ªõc check-in (SCHEDULED -> IN_PROGRESS)

**Login as**: khoa.la (Doctor)

```
PATCH /api/v1/appointments/APT-20251104-005/status
Authorization: Bearer {{doctor_token}}

{
  "status": "IN_PROGRESS"
}
```

**Expected**: 409 CONFLICT

```json
{
  "errorCode": "INVALID_STATE_TRANSITION",
  "detail": "Cannot transition from SCHEDULED to IN_PROGRESS. Allowed transitions: [CHECKED_IN, CANCELLED, NO_SHOW]"
}
```

**Reason**: Ph·∫£i check-in tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu kh√°m.

### Error Case 4: Appointment kh√¥ng t·ªìn t·∫°i

**Login as**: admin

```
PATCH /api/v1/appointments/APT-99999-999/status
Authorization: Bearer {{admin_token}}

{
  "status": "CHECKED_IN"
}
```

**Expected**: 404 NOT FOUND

### Edge Case 1: H·ªßy sau khi ƒë√£ check-in (CHECKED_IN -> CANCELLED)

**Login as**: thuan.dk (Receptionist)

```
PATCH /api/v1/appointments/APT-20251104-006/status
Authorization: Bearer {{receptionist_token}}

{
  "status": "CANCELLED",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "B·ªánh nh√¢n ƒë·∫øn r·ªìi nh∆∞ng kh√¥ng mu·ªën kh√°m n·ªØa"
}
```

**Expected**: 200 OK

- status = "CANCELLED"
- cancellationReason = "PATIENT_REQUEST: B·ªánh nh√¢n ƒë·∫øn r·ªìi nh∆∞ng kh√¥ng mu·ªën kh√°m n·ªØa"

**Use case**: B·ªánh nh√¢n ƒë√£ check-in nh∆∞ng sau ƒë√≥ t·ª´ ch·ªëi kh√°m.

### Edge Case 2: H·ªßy gi·ªØa ch·ª´ng (IN_PROGRESS -> CANCELLED)

**Login as**: khoa.la (Doctor)

```
PATCH /api/v1/appointments/APT-20251104-007/status
Authorization: Bearer {{doctor_token}}

{
  "status": "CANCELLED",
  "reasonCode": "MEDICAL_EMERGENCY",
  "notes": "B·ªánh nh√¢n c√≥ ph·∫£n ·ª©ng d·ªã ·ª©ng, chuy·ªÉn c·∫•p c·ª©u"
}
```

**Expected**: 200 OK

- status = "CANCELLED"
- actualStartTime = "2025-11-04T09:05:00" (V·∫´n gi·ªØ)
- actualEndTime = null (Ch∆∞a ho√†n th√†nh)

**Use case**: Tr∆∞·ªùng h·ª£p kh·∫©n c·∫•p ph·∫£i d·ª´ng ƒëi·ªÅu tr·ªã.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
IMPLEMENTATION NOTES (P3.5)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. SELECT FOR UPDATE (Pessimistic Locking)

   - Query: SELECT \* FROM appointments WHERE appointment_code = ? FOR UPDATE
   - JPA: @Lock(LockModeType.PESSIMISTIC_WRITE)
   - Purpose: NgƒÉn 2 l·ªÖ t√¢n/b√°c sƒ© c√πng update status m·ªôt l√∫c
   - Transaction: MUST use @Transactional

2. State Machine Validation

   - Hard-coded map: VALID_TRANSITIONS
   - Example: SCHEDULED -> [CHECKED_IN, CANCELLED, NO_SHOW]
   - Invalid transition ‚Üí 409 CONFLICT
   - Terminal states (COMPLETED, CANCELLED, NO_SHOW) ‚Üí Empty set

3. Timestamp Update Logic (CRITICAL)

   CHECKED_IN (L·ªÖ t√¢n):

   - ‚ùå KH√îNG c·∫≠p nh·∫≠t actual_start_time
   - ‚úÖ B·ªánh nh√¢n ch·ªâ ƒë·∫øn ph√≤ng ch·ªù, ch∆∞a v√†o gh·∫ø

   IN_PROGRESS (B√°c sƒ©):

   - ‚úÖ C·∫¨P NH·∫¨T actual_start_time = NOW()
   - ‚úÖ B·∫Øt ƒë·∫ßu ƒëi·ªÅu tr·ªã th·ª±c s·ª±

   COMPLETED:

   - ‚úÖ C·∫¨P NH·∫¨T actual_end_time = NOW()
   - ‚úÖ K·∫øt th√∫c ƒëi·ªÅu tr·ªã

   Business Value:

   - Patient Wait Time = actual_start_time - (CHECKED_IN timestamp from audit log)
   - Treatment Duration = actual_end_time - actual_start_time
   - Chair Utilization = Treatment Duration / Expected Duration

4. Business Rule Validation

   - CANCELLED: reasonCode is REQUIRED
   - Validation: Check before updating DB
   - Error: 400 BAD_REQUEST

5. Audit Logging

   - Table: appointment_audit_logs
   - Fields: action_type = STATUS_CHANGE, old_status, new_status, reason_code, notes, changed_by_employee_id
   - Use case: Compliance, tracking who changed what

6. Response Format

   - Return full detail DTO (same as API 3.4)
   - FE can immediately update UI without re-fetching
   - Include actualStartTime, actualEndTime in response

7. Security

   - Permission: UPDATE_APPOINTMENT_STATUS
   - Employee ID from token: auth.principal.username -> employees.account_id
   - If not found ‚Üí changed_by_employee_id = 0 (SYSTEM)

8. Performance

   - Pessimistic lock: Blocks concurrent updates on SAME appointment
   - Does NOT block updates on DIFFERENT appointments
   - Lock released on transaction commit/rollback

9. Error Handling

   - 404: Appointment not found
   - 409: Invalid state transition
   - 400: Missing reasonCode for CANCELLED
   - 500: Database error (transaction rollback)

10. Future Enhancements (Optional)

    - CHECK_IN_TOO_EARLY validation (>30 minutes before scheduled time)
    - Auto NO_SHOW after 15 minutes late
    - SMS notification on status change
    - WebSocket real-time update to dashboard

---

## PATCH DELAY APPOINTMENT (P3.6)

**Endpoint:** `PATCH /api/v1/appointments/{appointmentCode}/delay`

**Permission:** `DELAY_APPOINTMENT`

**Roles with Permission:**

- RECEPTIONIST (reschedule for patients)
- DENTIST (delay when needed)
- MANAGER (full control)

### 1. Overview

Delay (reschedule) an appointment to a new time slot. This API:

- Only works for SCHEDULED or CHECKED_IN appointments
- Validates new time is after original time
- Checks conflicts for doctor, room, patient, and participants
- Creates audit log with DELAY action type
- Preserves appointment status (still SCHEDULED/CHECKED_IN after delay)

### 2. Business Rules

1. **Status Validation:**

   - Only `SCHEDULED` or `CHECKED_IN` can be delayed
   - Terminal states (COMPLETED, CANCELLED, NO_SHOW) cannot be delayed
   - IN_PROGRESS cannot be delayed (treatment already started)

2. **Time Validation:**

   - `newStartTime` MUST be after `appointmentStartTime`
   - `newStartTime` should NOT be in the past
   - Duration remains the same (`expectedDurationMinutes`)
   - `newEndTime` = `newStartTime` + `expectedDurationMinutes`

3. **Conflict Checking:**

   - Doctor availability (no conflicting appointments)
   - Room availability (not occupied)
   - Patient availability (no double-booking)
   - Participants availability (nurses, assistants)

4. **Audit Trail:**
   - Action type: `DELAY`
   - Records `oldStartTime` and `newStartTime`
   - Preserves `oldStatus` = `newStatus` (status unchanged)
   - Includes `reasonCode` and `notes`

### 3. Request

#### Path Parameters

- `appointmentCode` (string, required): Appointment code (e.g., "APT-20251115-001")

#### Request Body

```json
{
  "newStartTime": "2025-11-15T15:00:00",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "B·ªánh nh√¢n y√™u c·∫ßu ho√£n v√¨ b·∫≠n vi·ªác ƒë·ªôt xu·∫•t"
}
```

#### Fields

| Field          | Type                  | Required | Description                      |
| -------------- | --------------------- | -------- | -------------------------------- |
| `newStartTime` | LocalDateTime         | Yes      | New start time (ISO 8601 format) |
| `reasonCode`   | AppointmentReasonCode | Yes      | Reason for delay (ENUM)          |
| `notes`        | String                | No       | Additional explanation           |

#### Valid Reason Codes for DELAY

```java
public enum AppointmentReasonCode {
    PATIENT_REQUEST,        // B·ªánh nh√¢n y√™u c·∫ßu
    DOCTOR_EMERGENCY,       // B√°c sƒ© c√≥ vi·ªác kh·∫©n c·∫•p
    EQUIPMENT_FAILURE,      // Thi·∫øt b·ªã h·ªèng
    TRAFFIC_DELAY,          // K·∫πt xe
    FAMILY_EMERGENCY,       // Gia ƒë√¨nh c√≥ vi·ªác kh·∫©n c·∫•p
    WEATHER_CONDITION,      // Th·ªùi ti·∫øt x·∫•u
    DOUBLE_BOOKING_ERROR,   // Nh·∫ßm l·ªãch tr√πng
    OTHER_REASON            // L√Ω do kh√°c
}
```

### 4. Response

#### Success Response (200 OK)

Returns full appointment detail (same as GET /{appointmentCode}):

```json
{
  "appointmentId": 1,
  "appointmentCode": "APT-20251115-001",
  "appointmentStartTime": "2025-11-15T15:00:00",
  "appointmentEndTime": "2025-11-15T15:45:00",
  "status": "SCHEDULED",
  "computedStatus": "SCHEDULED",
  "patient": {
    "patientId": 10,
    "fullName": "Nguy·ªÖn VƒÉn An",
    "phone": "0909123456",
    "dateOfBirth": "1990-05-15",
    "gender": "MALE"
  },
  "doctor": {
    "employeeId": 1,
    "employeeCode": "EMP001",
    "fullName": "Dr. L√™ Th·ªã Anh",
    "specialization": "ORTHODONTICS"
  },
  "room": {
    "roomId": "R001",
    "roomName": "Ph√≤ng kh√°m 1",
    "roomType": "EXAMINATION"
  },
  "services": [
    {
      "serviceId": 1,
      "serviceName": "Ni·ªÅng rƒÉng",
      "serviceDuration": 45
    }
  ],
  "expectedDurationMinutes": 45,
  "actualStartTime": null,
  "actualEndTime": null,
  "cancellationReason": null,
  "participants": [],
  "createdBy": "letan1",
  "createdAt": "2025-11-14T09:00:00"
}
```

#### Error Responses

**400 Bad Request - New time in past**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Cannot delay appointment to a time in the past: 2025-11-14T14:00:00"
}
```

**400 Bad Request - New time before original**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 400,
  "error": "Bad Request",
  "message": "New start time (2025-11-15T07:00:00) must be after original start time (2025-11-15T08:00:00)"
}
```

**403 Forbidden - No permission**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 403,
  "error": "Forbidden",
  "message": "Access Denied"
}
```

**404 Not Found**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 404,
  "error": "Not Found",
  "message": "Appointment not found: APT-20251115-999"
}
```

**409 Conflict - Invalid status**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 409,
  "error": "Conflict",
  "message": "Cannot delay appointment in status COMPLETED. Only SCHEDULED or CHECKED_IN appointments can be delayed."
}
```

**409 Conflict - Doctor unavailable**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 409,
  "error": "Conflict",
  "message": "Doctor has conflicting appointment during 2025-11-15T15:00:00 - 2025-11-15T15:45:00"
}
```

**409 Conflict - Room occupied**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 409,
  "error": "Conflict",
  "message": "Room R001 is occupied during 2025-11-15T15:00:00 - 2025-11-15T15:45:00"
}
```

**409 Conflict - Patient double-booked**

```json
{
  "timestamp": "2025-11-15T10:30:00",
  "status": 409,
  "error": "Conflict",
  "message": "Patient already has another appointment during 2025-11-15T15:00:00 - 2025-11-15T15:45:00"
}
```

### 5. Test Cases

#### Test 1: Success - RECEPTIONIST delays SCHEDULED appointment

**Prerequisites:**

- Login as `letan1` (RECEPTIONIST, has DELAY_APPOINTMENT permission)
- Appointment APT-20251115-001 exists
- Status: SCHEDULED
- Original time: 2025-11-15 08:00
- New time slot 15:00-15:45 is available (doctor, room, patient free)

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T15:00:00",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "B·ªánh nh√¢n y√™u c·∫ßu ho√£n v√¨ b·∫≠n vi·ªác ƒë·ªôt xu·∫•t"
}
```

**Expected Response:**

- Status: `200 OK`
- `appointmentStartTime`: "2025-11-15T15:00:00"
- `appointmentEndTime`: "2025-11-15T15:45:00"
- `status`: "SCHEDULED" (unchanged)
- Audit log created with action=DELAY

**Verification:**

```sql
-- Check appointment updated
SELECT appointment_code, appointment_start_time, appointment_end_time, status
FROM appointments
WHERE appointment_code = 'APT-20251115-001';

-- Check audit log
SELECT action_type, old_start_time, new_start_time, reason_code, notes
FROM appointment_audit_logs
WHERE appointment_id = (SELECT appointment_id FROM appointments WHERE appointment_code = 'APT-20251115-001')
ORDER BY created_at DESC
LIMIT 1;
```

---

#### Test 2: Success - DENTIST delays CHECKED_IN appointment

**Prerequisites:**

- Login as `letran` (DENTIST, has DELAY_APPOINTMENT permission)
- Appointment APT-20251115-002 exists
- Status: CHECKED_IN (patient waiting)
- Original time: 2025-11-15 09:00
- New time slot 10:00-10:45 is available

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-002/delay
Authorization: Bearer {{letran_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T10:00:00",
  "reasonCode": "DOCTOR_EMERGENCY",
  "notes": "B√°c sƒ© b·∫≠n x·ª≠ l√Ω ca kh·∫©n c·∫•p tr∆∞·ªõc"
}
```

**Expected Response:**

- Status: `200 OK`
- `status`: "CHECKED_IN" (unchanged)
- Times updated correctly

---

#### Test 3: Error - Cannot delay COMPLETED appointment

**Prerequisites:**

- Appointment APT-20251114-001 exists
- Status: COMPLETED
- Login as `letan1`

**Request:**

```http
PATCH /api/v1/appointments/APT-20251114-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-16T10:00:00",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "Test"
}
```

**Expected Response:**

- Status: `409 Conflict`
- Message: "Cannot delay appointment in status COMPLETED..."

---

#### Test 4: Error - New time before original

**Prerequisites:**

- Appointment APT-20251115-001 exists
- Original time: 2025-11-15 08:00
- Login as `letan1`

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T07:00:00",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "Test"
}
```

**Expected Response:**

- Status: `400 Bad Request`
- Message: "New start time (07:00) must be after original start time (08:00)"

---

#### Test 5: Error - Doctor has conflicting appointment

**Prerequisites:**

- Appointment APT-20251115-001 exists (Dr. L√™ Tr·∫ßn, 08:00-08:45)
- Appointment APT-20251115-003 exists (Dr. L√™ Tr·∫ßn, 15:00-15:45)
- Login as `letan1`

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T15:00:00",
  "reasonCode": "PATIENT_REQUEST"
}
```

**Expected Response:**

- Status: `409 Conflict`
- Message: "Doctor has conflicting appointment during 15:00 - 15:45"

---

#### Test 6: Error - Room occupied

**Prerequisites:**

- Appointment APT-20251115-001 exists (Room R001, 08:00-08:45)
- Appointment APT-20251115-004 exists (Room R001, 15:00-16:00)
- Login as `letan1`

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T15:00:00",
  "reasonCode": "EQUIPMENT_FAILURE"
}
```

**Expected Response:**

- Status: `409 Conflict`
- Message: "Room R001 is occupied during 15:00 - 15:45"

---

#### Test 7: Error - Patient double-booked

**Prerequisites:**

- Patient Nguy·ªÖn VƒÉn An has appointment APT-20251115-001 at 08:00
- Same patient has appointment APT-20251115-005 at 15:00
- Login as `letan1`

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T15:00:00",
  "reasonCode": "PATIENT_REQUEST"
}
```

**Expected Response:**

- Status: `409 Conflict`
- Message: "Patient already has another appointment during 15:00 - 15:45"

---

#### Test 8: Error - No permission (PATIENT role)

**Prerequisites:**

- Login as `patient_user` (ROLE_PATIENT, does NOT have DELAY_APPOINTMENT)
- Appointment APT-20251115-001 exists (owned by this patient)

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{patient_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T15:00:00",
  "reasonCode": "PATIENT_REQUEST"
}
```

**Expected Response:**

- Status: `403 Forbidden`
- Message: "Access Denied"

---

#### Test 9: Edge Case - Delay to same day (cross date boundary warning)

**Prerequisites:**

- Appointment APT-20251115-001 exists at 2025-11-15 17:00
- Delay to next day 2025-11-16 08:00
- Login as `letan1`

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-16T08:00:00",
  "reasonCode": "PATIENT_REQUEST",
  "notes": "Ho√£n sang ng√†y mai"
}
```

**Expected Response:**

- Status: `200 OK`
- Times updated successfully
- Log contains warning: "Appointment delayed from 2025-11-15 to 2025-11-16 (crosses date boundary)"

---

#### Test 10: Success - Delay with participants (nurses)

**Prerequisites:**

- Appointment APT-20251115-001 has participants: Nurse A (08:00-08:45)
- New time slot 15:00-15:45 is free for doctor, room, patient, AND Nurse A
- Login as `letan1`

**Request:**

```http
PATCH /api/v1/appointments/APT-20251115-001/delay
Authorization: Bearer {{letan1_token}}
Content-Type: application/json

{
  "newStartTime": "2025-11-15T15:00:00",
  "reasonCode": "PATIENT_REQUEST"
}
```

**Expected Response:**

- Status: `200 OK`
- All conflict checks passed (including participant)
- Appointment delayed successfully

**Verification:**

```sql
-- Check participants still assigned
SELECT ap.employee_id, ap.participant_role
FROM appointment_participants ap
JOIN appointments a ON ap.appointment_id = a.appointment_id
WHERE a.appointment_code = 'APT-20251115-001';
```

---

### 6. Database Impact

#### Tables Modified

1. **appointments:**

   - `appointment_start_time`: Updated to new start time
   - `appointment_end_time`: Recalculated (start + duration)
   - `status`: Unchanged (still SCHEDULED/CHECKED_IN)

2. **appointment_audit_logs:**
   - New row inserted:
     - `action_type`: DELAY
     - `old_status`: Same as current status
     - `new_status`: Same as current status
     - `old_start_time`: Original start time
     - `new_start_time`: New start time
     - `reason_code`: From request
     - `notes`: From request
     - `performed_by_employee_id`: Current employee ID

#### Example Audit Log Entry

```sql
INSERT INTO appointment_audit_logs (
    appointment_id,
    action_type,
    old_status,
    new_status,
    old_start_time,
    new_start_time,
    reason_code,
    notes,
    performed_by_employee_id,
    created_at
) VALUES (
    1,
    'DELAY',
    'SCHEDULED',
    'SCHEDULED',
    '2025-11-15 08:00:00',
    '2025-11-15 15:00:00',
    'PATIENT_REQUEST',
    'B·ªánh nh√¢n y√™u c·∫ßu ho√£n v√¨ b·∫≠n vi·ªác ƒë·ªôt xu·∫•t',
    1,
    NOW()
);
```

### 7. Security

- **Permission:** `DELAY_APPOINTMENT`
- **Roles:** RECEPTIONIST, DENTIST, MANAGER
- **Employee ID extraction:** `auth.principal.username` ‚Üí `employees.account_id`
- **Pessimistic Lock:** Prevents concurrent modifications to same appointment

### 8. Performance

- **Pessimistic Lock:** `SELECT FOR UPDATE` blocks concurrent delays
- **4 Conflict Queries:** Doctor, Room, Patient, Participants (N+1 for participants)
- **Transaction:** All operations atomic (rollback on any conflict)
- **Index Required:**
  - `appointments(employee_id, status, appointment_start_time, appointment_end_time)`
  - `appointments(room_id, status, appointment_start_time, appointment_end_time)`
  - `appointments(patient_id, status, appointment_start_time, appointment_end_time)`
  - `appointment_participants(appointment_id, employee_id)`

### 9. Error Handling

| Status | Scenario              | Message                                                          |
| ------ | --------------------- | ---------------------------------------------------------------- |
| 400    | New time in past      | "Cannot delay appointment to a time in the past: {newStartTime}" |
| 400    | New time ‚â§ original   | "New start time must be after original start time"               |
| 403    | No permission         | "Access Denied"                                                  |
| 404    | Appointment not found | "Appointment not found: {appointmentCode}"                       |
| 409    | Invalid status        | "Cannot delay appointment in status {status}..."                 |
| 409    | Terminal state        | "Cannot delay appointment in terminal state: {status}"           |
| 409    | Doctor conflict       | "Doctor has conflicting appointment during {start} - {end}"      |
| 409    | Room conflict         | "Room {roomId} is occupied during {start} - {end}"               |
| 409    | Patient conflict      | "Patient already has another appointment during {start} - {end}" |
| 409    | Participant conflict  | "Participant (employeeId={id}) has conflicting appointment..."   |
| 500    | Database error        | Transaction rollback                                             |

### 10. Future Enhancements

- **Notification:** Send SMS/Email to patient about schedule change
- **Auto-reschedule:** Suggest available time slots based on conflicts
- **Bulk delay:** Delay multiple appointments at once (e.g., doctor sick leave)
- **Recurring appointments:** Delay all future occurrences
- **Undo delay:** Revert to original time within 5 minutes
- **Approval workflow:** Require manager approval for delays >24 hours

---
